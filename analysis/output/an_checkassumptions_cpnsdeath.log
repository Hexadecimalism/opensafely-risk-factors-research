---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Github\opencorona-risk-factors-research\analysis\output/an_checkassumptions_cpnsdeath.log
  log type:  text
 opened on:  28 Apr 2020, 17:16:08

. 
. use cr_create_analysis_dataset, clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. *local outcome "cpnsdeath"
. *replace cpnsdeath = uniform()<0.3
. 
. 
. 
. ******************************
. *  Multivariable Cox models  *
. ******************************
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         i.htdiag_or_highbp                              ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.chronic_kidney_disease                ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         other_immunosuppression                 ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. 
. 
. * Set as survival outcome
. stset stime_`outcome', fail(`outcome') enter(enter_date) origin(enter_date) id(patient_id) 

                id:  patient_id
     failure event:  cpnsdeath != 0 & cpnsdeath < .
obs. time interval:  (stime_cpnsdeath[_n-1], stime_cpnsdeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
    100,575  total observations
          3  observations end on or before enter()
------------------------------------------------------------------------------
    100,572  observations remaining, representing
    100,572  subjects
          1  failure in single-failure-per-subject data
  8,447,712  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        84

. 
. 
.                         
. * Age spline model (not adj ethnicity)
. basecoxmodel, age("age1 age2 age3")  ethnicity(0)
   1:      7.55 /        1 =       7.5470

. if _rc==0 {
.         
.         estimates
.         * estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_noeth, replace
. 
.         /*  Proportional Hazards test  */
.         
.         * Based on Schoenfeld residuals
.         timer clear 
.         timer on 1
.         if e(N_fail)>0 estat phtest, d
.         timer off 1
.         timer list
.         
.         
.         /*  Concordance statistic  */
.         
.         timer clear 
.         timer on 2
.         set seed 12437
.         
.         qui count if `outcome'==0
.         local N0 = r(N)
.         local p0 = 5000/`N0'
.         qui count if `outcome'==1
.         local N1 = r(N)
.         local p1 = 5000/`N1'    
.         
.         noi di "Fraction of controls to be used" `p0'
.         noi di "Fraction of cases to be used" `p1'
.         local csum = 0
.         forvalues i = 1 (1) 10 {
  2.                 gen     rsample`i' = uniform()<`p0' if `outcome'==0
  3.                 replace rsample`i' = uniform()<`p1' if `outcome'==1
  4.                 estat concordance if rsample`i'==1
  5.                 local cstat`i' =  r(C)
  6.                 noi di "C-statistic in `i' th sample = " `cstat`i''
  7.                 local csum = `csum' + `cstat`i''
  8.                 drop rsample`i'
  9.         }
.         local csum = `csum'/10
.         noi di "Average C-statistic = " `csum'
.         timer off 2
.         timer list      
.         
.         
.         /*  Brier score  */
.         
.         timer clear 
.         timer on 3
. 
.         * Calculate at 60 days
.         
.         * Unadjusted
.         capture stbrier, bt(60) efron
.         if _rc==0 {
.             noi di "Brier score, unadjusted"
.                 estimates
.         }
. 
.         * Fully adjusted
.         capture stbrier age1 age2 age3          ///
>                 i.male                                                  ///
>                 i.obese4cat                                             ///
>                 i.smoke_nomiss                                  ///
>                 i.imd                                                   ///
>                 i.htdiag_or_highbp                              ///
>                 i.chronic_respiratory_disease   ///
>                 i.asthmacat                                             ///
>                 i.chronic_cardiac_disease               ///
>                 i.diabcat                                               ///
>                 i.cancer_exhaem_cat                             ///
>                 i.cancer_haem_cat                               ///
>                 i.chronic_liver_disease                 ///
>                 i.stroke_dementia                               ///
>                 i.other_neuro                                   ///
>                 i.chronic_kidney_disease                ///
>                 i.organ_transplant                              ///
>                 i.spleen                                                ///
>                 i.ra_sle_psoriasis                      ///
>                 other_immunosuppression                 ///
>                 , shared(stp) bt(60)                    ///
>                 ipcw(age1 age2 age3                             ///
>                 i.male                                                  ///
>                 i.obese4cat                                             ///
>                 i.smoke_nomiss                                  ///
>                 i.imd                                                   ///
>                 i.htdiag_or_highbp                              ///
>                 i.chronic_respiratory_disease   ///
>                 i.asthmacat                                             ///
>                 i.chronic_cardiac_disease               ///
>                 i.diabcat                                               ///
>                 i.cancer_exhaem_cat                             ///
>                 i.cancer_haem_cat                               ///
>                 i.chronic_liver_disease                 ///
>                 i.stroke_dementia                               ///
>                 i.other_neuro                                   ///
>                 i.chronic_kidney_disease                ///
>                 i.organ_transplant                              ///
>                 i.spleen                                                ///
>                 i.ra_sle_psoriasis                      ///
>                 other_immunosuppression)
.         if _rc==0 {
.             noi di "Brier score, fully adjusted"
.                 estimates
.         }
. 
.         timer off 3
.         timer list
.         
. }

. else di "WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME `outcome')"
WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME cpnsdeath)

. 
. 
. 
. 
. 
. log close
      name:  <unnamed>
       log:  C:\Github\opencorona-risk-factors-research\analysis\output/an_checkassumptions_cpnsdeath.log
  log type:  text
 closed on:  28 Apr 2020, 17:16:17
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
