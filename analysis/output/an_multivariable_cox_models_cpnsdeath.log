---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Github\opencorona-risk-factors-research\analysis\output/an_multivariable_cox_models_cpnsdeath.log
  log type:  text
 opened on:  28 Apr 2020, 17:11:28

. 
. use cr_create_analysis_dataset, clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. 
. ******************************
. *  Multivariable Cox models  *
. ******************************
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         i.htdiag_or_highbp                              ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.chronic_kidney_disease                ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_immunosuppression                       ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. 
. 
. stset stime_`outcome', fail(`outcome') enter(enter_date) origin(enter_date) id(patient_id) 

                id:  patient_id
     failure event:  cpnsdeath != 0 & cpnsdeath < .
obs. time interval:  (stime_cpnsdeath[_n-1], stime_cpnsdeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
    100,575  total observations
          3  observations end on or before enter()
------------------------------------------------------------------------------
    100,572  observations remaining, representing
    100,572  subjects
          1  failure in single-failure-per-subject data
  8,447,712  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        84

. 
. *Age spline model (not adj ethnicity)
. basecoxmodel, age("age1 age2 age3")  ethnicity(0)
   1:      8.03 /        1 =       8.0320

. if _rc==0{
. estimates
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_noeth, replace
. *estat concordance /*c-statistic*/
. }

. else di "WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME `outcome')"
WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME cpnsdeath)

.  
. *Age group model (not adj ethnicity)
. basecoxmodel, age("ib3.agegroup")  ethnicity(0)
   1:     17.82 /        1 =      17.8160

. if _rc==0{
. estimates

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
active results
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- no ties

No. of subjects =       99,184                  Number of obs    =      99,184
No. of failures =            1
Time at risk    =      8331120
                                                LR chi2(25)      =        8.06
Log likelihood  =   -6.0822189                  Prob > chi2      =      0.9995

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     agegroup |
                      18-<40  |   9.38e+14   4.27e+22     0.00   1.000            0           .
                      40-<50  |   .0584228   1.03e+07    -0.00   1.000            0           .
                      60-<70  |   .0206553    6169220    -0.00   1.000            0           .
                      70-<80  |   .0298039    7393117    -0.00   1.000            0           .
                         80+  |   .0114279    4582210    -0.00   1.000            0           .
                              |
                       1.male |   2.11e-16   1.54e-08    -0.00   1.000            0           .
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.222396   2.51e+08     0.00   1.000            0           .
          Obese II (35-39.9)  |   .2772739   1.61e+08    -0.00   1.000            0           .
             Obese III (40+)  |   .1596595   1.24e+08    -0.00   1.000            0           .
                              |
                 smoke_nomiss |
                      Former  |   3.37e-15   6.01e-07    -0.00   1.000            0           .
                     Current  |   1.46e-15   1.30e-07    -0.00   1.000            0           .
                              |
                          imd |
                           2  |   .1624426   4.95e+07    -0.00   1.000            0           .
                           3  |    .128876   3.21e+07    -0.00   1.000            0           .
                           4  |   5.60e+15   3.27e+23     0.00   1.000            0           .
             5 most deprived  |   .1418804   4.29e+07    -0.00   1.000            0           .
                              |
           1.htdiag_or_highbp |   1.21e-15   1.95e-07    -0.00   1.000            0           .
1.chronic_respiratory_disease |   .1144307   7.60e+07    -0.00   1.000            0           .
                              |
                    asthmacat |
                 Yes, no OCS  |   1.16e-15   4.11e-07    -0.00   1.000            0           .
    1.chronic_cardiac_disease |   2.73e-15   1.09e-06    -0.00   1.000            0           .
                              |
                      diabcat |
         Controlled diabetes  |   4.42e-15   3.86e-07    -0.00   1.000            0           .
                              |
            cancer_exhaem_cat |
                   Last year  |   1.99e+59          .        .       .            .           .
               2-5 years ago  |   7.49e+12          .        .       .            .           .
                    5+ years  |   4.47e-16   3.13e-07    -0.00   1.000            0           .
                              |
              cancer_haem_cat |
                   Last year  |   3.53e+11          .        .       .            .           .
               2-5 years ago  |   9.53e+22          .        .       .            .           .
                    5+ years  |   1.71e+13          .        .       .            .           .
                              |
      1.chronic_liver_disease |   1.02e+27          .        .       .            .           .
            1.stroke_dementia |   2.95e+14   6.27e+23     0.00   1.000            0           .
                1.other_neuro |   1.06e+14          .        .       .            .           .
     1.chronic_kidney_disease |   1.10e-15   6.93e-07    -0.00   1.000            0           .
           1.organ_transplant |   2.26e-44          .        .       .            .           .
                     1.spleen |   1.85e+14   5.65e+23     0.00   1.000            0           .
           1.ra_sle_psoriasis |   1.428461   1.23e+09     0.00   1.000            0           .
    1.other_immunosuppression |    .015855          .        .       .            .           .
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agegroup_bmicat_noeth, replace
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agegroup_bmicat_noeth.ster not found)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agegroup_bmicat_noeth.ster saved
. *estat concordance /*c-statistic*/
. }

. else di "WARNING GROUP MODEL DID NOT FIT (OUTCOME `outcome')"

. 
. *Complete case ethnicity model
. basecoxmodel, age("age1 age2 age3")  ethnicity(1)
   1:      0.81 /        1 =       0.8050

. if _rc==0{
. estimates

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
active results
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- no ties

No. of subjects =       19,794                  Number of obs    =      19,794
No. of failures =            0
Time at risk    =      1662696
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |          1  (omitted)
                         age2 |          1  (omitted)
                         age3 |          1  (omitted)
                       1.male |          1  (omitted)
                              |
                    obese4cat |
           Obese I (30-34.9)  |          1  (omitted)
          Obese II (35-39.9)  |          1  (omitted)
             Obese III (40+)  |          1  (omitted)
                              |
                 smoke_nomiss |
                      Former  |          1  (omitted)
                     Current  |          1  (omitted)
                              |
                    ethnicity |
                       Mixed  |          1  (omitted)
      Asian or Asian British  |          1  (omitted)
                       Black  |          1  (omitted)
                       Other  |          1  (omitted)
                              |
                          imd |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                           4  |          1  (omitted)
             5 most deprived  |          1  (omitted)
                              |
           1.htdiag_or_highbp |          1  (omitted)
1.chronic_respiratory_disease |          1  (omitted)
                              |
                    asthmacat |
                 Yes, no OCS  |          1  (omitted)
    1.chronic_cardiac_disease |          1  (omitted)
                              |
                      diabcat |
         Controlled diabetes  |          1  (omitted)
                              |
            cancer_exhaem_cat |
                   Last year  |          1  (omitted)
               2-5 years ago  |          1  (omitted)
                    5+ years  |          1  (omitted)
                              |
              cancer_haem_cat |
                    5+ years  |          1  (omitted)
      1.chronic_liver_disease |          1  (omitted)
            1.stroke_dementia |          1  (omitted)
                1.other_neuro |          1  (omitted)
     1.chronic_kidney_disease |          1  (omitted)
           0.organ_transplant |          1  (omitted)
                     0.spleen |          1  (omitted)
           1.ra_sle_psoriasis |          1  (omitted)
    1.other_immunosuppression |          1  (omitted)
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_CCeth, replace
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCeth.ster not found)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCeth.ster saved
. *estat concordance /*c-statistic*/
.  }

.  else di "WARNING CC ETHNICITY MODEL DID NOT FIT (OUTCOME `outcome')"

. 
.  
. *Model without ethnicity among ethnicity complete cases 
. basecoxmodel, age("age1 age2 age3")  ethnicity(0) if("if ethnicity<.")
   1:      0.76 /        1 =       0.7600

. if _rc==0{
. estimates

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
active results
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- no ties

No. of subjects =       19,794                  Number of obs    =      19,794
No. of failures =            0
Time at risk    =      1662696
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |          1  (omitted)
                         age2 |          1  (omitted)
                         age3 |          1  (omitted)
                       1.male |          1  (omitted)
                              |
                    obese4cat |
           Obese I (30-34.9)  |          1  (omitted)
          Obese II (35-39.9)  |          1  (omitted)
             Obese III (40+)  |          1  (omitted)
                              |
                 smoke_nomiss |
                      Former  |          1  (omitted)
                     Current  |          1  (omitted)
                              |
                          imd |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                           4  |          1  (omitted)
             5 most deprived  |          1  (omitted)
                              |
           1.htdiag_or_highbp |          1  (omitted)
1.chronic_respiratory_disease |          1  (omitted)
                              |
                    asthmacat |
                 Yes, no OCS  |          1  (omitted)
    1.chronic_cardiac_disease |          1  (omitted)
                              |
                      diabcat |
         Controlled diabetes  |          1  (omitted)
                              |
            cancer_exhaem_cat |
                   Last year  |          1  (omitted)
               2-5 years ago  |          1  (omitted)
                    5+ years  |          1  (omitted)
                              |
              cancer_haem_cat |
                    5+ years  |          1  (omitted)
      1.chronic_liver_disease |          1  (omitted)
            1.stroke_dementia |          1  (omitted)
                1.other_neuro |          1  (omitted)
     1.chronic_kidney_disease |          1  (omitted)
           0.organ_transplant |          1  (omitted)
                     0.spleen |          1  (omitted)
           1.ra_sle_psoriasis |          1  (omitted)
    1.other_immunosuppression |          1  (omitted)
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_CCnoeth, replace
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCnoeth.ster not found)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCnoeth.ster saved
. *estat concordance /*c-statistic*/
.  }

.  else di "WARNING CC MODEL (excluding ethnicity) DID NOT FIT (OUTCOME `outcome')"

.  
. /* 
> *PRIMARY MODEL PH TEST 
> estimates use ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_noeth
> estat phtest
> */
. ************************************************************************
. * Add IBS 
. 
. * Calculate at 60 days
. *
. *stbrier, bt(60) efron
. 
. /*
> stbrier age1 age2 age3 male i.bmicat i.smoke                                                    ///
>                 resp asthma heart diabetes cancer liver neuro_dis kidney_dis    ///
>                 transplant spleen immunosup hypertension autoimmune sle                 ///
>                 endocrine                                                                                                               ///
>                 , shared(stp) bt(60)                                                                                    ///
>                 ipcw(age1 age2 age3 male i.bmicat i.smoke                                               ///
>                 resp asthma heart diabetes cancer liver neuro_dis kidney_dis    ///
>                 transplant spleen immunosup hypertension autoimmune sle                 ///
>                 endocrine)
> */
. 
. * Simple model just to try:
. /*
> stbrier age1 age2 age3 male                                                                                     ///
>                 , shared(stp) bt(60)                                                                                    ///
>                 ipcw(age1 age2 age3 male)
> */
. ************************************************************************
. 
. 
. * Close log file  (bootstrapping likely to take a while)
. log close
      name:  <unnamed>
       log:  C:\Github\opencorona-risk-factors-research\analysis\output/an_multivariable_cox_models_cpnsdeath.log
  log type:  text
 closed on:  28 Apr 2020, 17:11:57
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
