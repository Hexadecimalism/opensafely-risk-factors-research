---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Github\opencorona-risk-factors-research\analysis\output/an_multivariable_cox_models_cpnsdeath.log
  log type:  text
 opened on:  27 Apr 2020, 23:16:14

. 
. use cr_create_analysis_dataset, clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. 
. ******************************
. *  Multivariable Cox models  *
. ******************************
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         i.htdiag_or_highbp                              ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.ckd                                                   ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_immunosuppression                       ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. 
. 
. stset stime_`outcome', fail(`outcome') enter(enter_date) origin(enter_date) id(patient_id) 

                id:  patient_id
     failure event:  cpnsdeath != 0 & cpnsdeath < .
obs. time interval:  (stime_cpnsdeath[_n-1], stime_cpnsdeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
    100,575  total observations
          3  observations end on or before enter()
------------------------------------------------------------------------------
    100,572  observations remaining, representing
    100,572  subjects
          1  failure in single-failure-per-subject data
  7,542,636  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        75

. 
. *Age spline model (not adj ethnicity)
. basecoxmodel, age("age1 age2 age3")  ethnicity(0)
   1:      1.08 /        1 =       1.0800

. if _rc==0{
. estimates

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
active results
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- no ties

No. of subjects =       23,215                  Number of obs    =      23,215
No. of failures =            0
Time at risk    =      1741125
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |          1  (omitted)
                         age2 |          1  (omitted)
                         age3 |          1  (omitted)
                       1.male |          1  (omitted)
                              |
                    obese4cat |
             Obese III (40+)  |          1  (omitted)
                              |
                 smoke_nomiss |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                              |
                          imd |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                           4  |          1  (omitted)
             5 most deprived  |          1  (omitted)
                              |
           1.htdiag_or_highbp |          1  (omitted)
1.chronic_respiratory_disease |          1  (omitted)
                              |
                    asthmacat |
                 Yes, no OCS  |          1  (omitted)
    1.chronic_cardiac_disease |          1  (omitted)
                              |
                      diabcat |
         Controlled diabetes  |          1  (omitted)
                              |
            cancer_exhaem_cat |
                   Last year  |          1  (omitted)
                    5+ years  |          1  (omitted)
                              |
              cancer_haem_cat |
                   Last year  |          1  (omitted)
                    5+ years  |          1  (omitted)
                              |
      1.chronic_liver_disease |          1  (omitted)
            1.stroke_dementia |          1  (omitted)
                1.other_neuro |          1  (omitted)
                              |
                          ckd |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                           4  |          1  (omitted)
                           5  |          1  (omitted)
                              |
           1.organ_transplant |          1  (omitted)
                     1.spleen |          1  (omitted)
           1.ra_sle_psoriasis |          1  (omitted)
    1.other_immunosuppression |          1  (omitted)
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_noeth, replace
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_noeth.ster not found)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_noeth.ster saved
. *estat concordance /*c-statistic*/
. }

. else di "WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME `outcome')"

.  
. *Age group model (not adj ethnicity)
. basecoxmodel, age("ib3.agegroup")  ethnicity(0)
   1:      1.13 /        1 =       1.1340

. if _rc==0{
. estimates

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
active results
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- no ties

No. of subjects =       23,215                  Number of obs    =      23,215
No. of failures =            0
Time at risk    =      1741125
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     agegroup |
                      18-<40  |          1  (omitted)
                      40-<50  |          1  (omitted)
                      60-<70  |          1  (omitted)
                      70-<80  |          1  (omitted)
                         80+  |          1  (omitted)
                              |
                       1.male |          1  (omitted)
                              |
                    obese4cat |
             Obese III (40+)  |          1  (omitted)
                              |
                 smoke_nomiss |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                              |
                          imd |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                           4  |          1  (omitted)
             5 most deprived  |          1  (omitted)
                              |
           1.htdiag_or_highbp |          1  (omitted)
1.chronic_respiratory_disease |          1  (omitted)
                              |
                    asthmacat |
                 Yes, no OCS  |          1  (omitted)
    1.chronic_cardiac_disease |          1  (omitted)
                              |
                      diabcat |
         Controlled diabetes  |          1  (omitted)
                              |
            cancer_exhaem_cat |
                   Last year  |          1  (omitted)
                    5+ years  |          1  (omitted)
                              |
              cancer_haem_cat |
                   Last year  |          1  (omitted)
                    5+ years  |          1  (omitted)
                              |
      1.chronic_liver_disease |          1  (omitted)
            1.stroke_dementia |          1  (omitted)
                1.other_neuro |          1  (omitted)
                              |
                          ckd |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                           4  |          1  (omitted)
                           5  |          1  (omitted)
                              |
           1.organ_transplant |          1  (omitted)
                     1.spleen |          1  (omitted)
           1.ra_sle_psoriasis |          1  (omitted)
    1.other_immunosuppression |          1  (omitted)
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agegroup_bmicat_noeth, replace
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agegroup_bmicat_noeth.ster not found)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agegroup_bmicat_noeth.ster saved
. *estat concordance /*c-statistic*/
. }

. else di "WARNING GROUP MODEL DID NOT FIT (OUTCOME `outcome')"

. 
. *Complete case ethnicity model
. basecoxmodel, age("age1 age2 age3")  ethnicity(1)
   1:      0.48 /        1 =       0.4820

. if _rc==0{
. estimates

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
active results
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- no ties

No. of subjects =           87                  Number of obs    =          87
No. of failures =            0
Time at risk    =         6525
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |          1  (omitted)
                         age2 |          1  (omitted)
                         age3 |          1  (omitted)
                       1.male |          1  (omitted)
                              |
                    obese4cat |
             Obese III (40+)  |          1  (omitted)
                              |
                 smoke_nomiss |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                              |
                    ethnicity |
                       Mixed  |          1  (omitted)
      Asian or Asian British  |          1  (omitted)
                       Black  |          1  (omitted)
                       Other  |          1  (omitted)
                              |
                          imd |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                           4  |          1  (omitted)
             5 most deprived  |          1  (omitted)
                              |
           1.htdiag_or_highbp |          1  (omitted)
1.chronic_respiratory_disease |          1  (omitted)
                              |
                    asthmacat |
                 Yes, no OCS  |          1  (omitted)
    1.chronic_cardiac_disease |          1  (omitted)
                              |
                      diabcat |
         Controlled diabetes  |          1  (omitted)
                              |
            cancer_exhaem_cat |
                    5+ years  |          1  (omitted)
                              |
              cancer_haem_cat |
                    5+ years  |          1  (omitted)
      0.chronic_liver_disease |          1  (omitted)
            1.stroke_dementia |          1  (omitted)
                1.other_neuro |          1  (omitted)
                              |
                          ckd |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                           4  |          1  (omitted)
                              |
           0.organ_transplant |          1  (omitted)
                     0.spleen |          1  (omitted)
           1.ra_sle_psoriasis |          1  (omitted)
    1.other_immunosuppression |          1  (omitted)
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_CCeth, replace
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCeth.ster not found)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCeth.ster saved
. *estat concordance /*c-statistic*/
.  }

.  else di "WARNING CC ETHNICITY MODEL DID NOT FIT (OUTCOME `outcome')"

. 
.  
. *Model without ethnicity among ethnicity complete cases 
. basecoxmodel, age("age1 age2 age3")  ethnicity(0) if("if ethnicity<.")
   1:      0.54 /        1 =       0.5350

. if _rc==0{
. estimates

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
active results
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- no ties

No. of subjects =           87                  Number of obs    =          87
No. of failures =            0
Time at risk    =         6525
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |          1  (omitted)
                         age2 |          1  (omitted)
                         age3 |          1  (omitted)
                       1.male |          1  (omitted)
                              |
                    obese4cat |
             Obese III (40+)  |          1  (omitted)
                              |
                 smoke_nomiss |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                              |
                          imd |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                           4  |          1  (omitted)
             5 most deprived  |          1  (omitted)
                              |
           1.htdiag_or_highbp |          1  (omitted)
1.chronic_respiratory_disease |          1  (omitted)
                              |
                    asthmacat |
                 Yes, no OCS  |          1  (omitted)
    1.chronic_cardiac_disease |          1  (omitted)
                              |
                      diabcat |
         Controlled diabetes  |          1  (omitted)
                              |
            cancer_exhaem_cat |
                    5+ years  |          1  (omitted)
                              |
              cancer_haem_cat |
                    5+ years  |          1  (omitted)
      0.chronic_liver_disease |          1  (omitted)
            1.stroke_dementia |          1  (omitted)
                1.other_neuro |          1  (omitted)
                              |
                          ckd |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                           4  |          1  (omitted)
                              |
           0.organ_transplant |          1  (omitted)
                     0.spleen |          1  (omitted)
           1.ra_sle_psoriasis |          1  (omitted)
    1.other_immunosuppression |          1  (omitted)
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_CCnoeth, replace
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCnoeth.ster not found)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCnoeth.ster saved
. *estat concordance /*c-statistic*/
.  }

.  else di "WARNING CC MODEL (excluding ethnicity) DID NOT FIT (OUTCOME `outcome')"

.  
. /* 
> *PRIMARY MODEL PH TEST 
> estimates use ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_noeth
> estat phtest
> */
. ************************************************************************
. * Add IBS 
. 
. * Calculate at 60 days
. *
. *stbrier, bt(60) efron
. 
. /*
> stbrier age1 age2 age3 male i.bmicat i.smoke                                                    ///
>                 resp asthma heart diabetes cancer liver neuro_dis kidney_dis    ///
>                 transplant spleen immunosup hypertension autoimmune sle                 ///
>                 endocrine                                                                                                               ///
>                 , shared(stp) bt(60)                                                                                    ///
>                 ipcw(age1 age2 age3 male i.bmicat i.smoke                                               ///
>                 resp asthma heart diabetes cancer liver neuro_dis kidney_dis    ///
>                 transplant spleen immunosup hypertension autoimmune sle                 ///
>                 endocrine)
> */
. 
. * Simple model just to try:
. /*
> stbrier age1 age2 age3 male                                                                                     ///
>                 , shared(stp) bt(60)                                                                                    ///
>                 ipcw(age1 age2 age3 male)
> */
. ************************************************************************
. 
. 
. * Close log file  (bootstrapping likely to take a while)
. log close
      name:  <unnamed>
       log:  C:\Github\opencorona-risk-factors-research\analysis\output/an_multivariable_cox_models_cpnsdeath.log
  log type:  text
 closed on:  27 Apr 2020, 23:16:18
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
