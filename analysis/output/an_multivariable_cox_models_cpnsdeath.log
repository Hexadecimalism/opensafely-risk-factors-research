---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Github\opencorona-risk-factors-research\analysis\output/an_multivariable_cox_models_cpnsdeath.log
  log type:  text
 opened on:  27 Apr 2020, 22:21:33

. 
. use cr_create_analysis_dataset, clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. 
. ******************************
. *  Multivariable Cox models  *
. ******************************
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         i.htdiag_or_highbp                              ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.ckd                                                   ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_immunosuppression                       ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. 
. 
. stset stime_`outcome', fail(`outcome') enter(enter_date) origin(enter_date) id(patient_id) 

                id:  patient_id
     failure event:  cpnsdeath != 0 & cpnsdeath < .
obs. time interval:  (stime_cpnsdeath[_n-1], stime_cpnsdeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
    100,575  total observations
          3  observations end on or before enter()
------------------------------------------------------------------------------
    100,572  observations remaining, representing
    100,572  subjects
          1  failure in single-failure-per-subject data
  7,542,636  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        75

. 
. *Age spline model (not adj ethnicity)
. basecoxmodel, age("age1 age2 age3")  ethnicity(0)
   1:      4.99 /        1 =       4.9850

. if _rc==0{
. estimates
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_noeth, replace
. *estat concordance /*c-statistic*/
. }

. else di "WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME `outcome')"
WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME cpnsdeath)

.  
. *Age group model (not adj ethnicity)
. basecoxmodel, age("ib3.agegroup")  ethnicity(0)
   1:      7.96 /        1 =       7.9610

. if _rc==0{
. estimates

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
active results
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- no ties

No. of subjects =       42,280                  Number of obs    =      42,280
No. of failures =            1
Time at risk    =      3170901
                                                LR chi2(25)      =        8.44
Log likelihood  =   -5.0434251                  Prob > chi2      =      0.9992

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     agegroup |
                      18-<40  |   4.89e+15   7.06e+23     0.00   1.000            0           .
                      40-<50  |   .0288704   1.84e+07    -0.00   1.000            0           .
                      60-<70  |   .1216279   3.88e+07    -0.00   1.000            0           .
                      70-<80  |   .0855388   3.01e+07    -0.00   1.000            0           .
                         80+  |   .0566481   2.43e+07    -0.00   1.000            0           .
                              |
                       1.male |   2.23e-16   1.65e-08    -0.00   1.000            0           .
                              |
                    obese4cat |
           Obese I (30-34.9)  |   602.8128   3.95e+11     0.00   1.000            0           .
          Obese II (35-39.9)  |   43.75522   4.34e+10     0.00   1.000            0           .
             Obese III (40+)  |   9.43e+13   7.13e+22     0.00   1.000            0           .
                              |
                 smoke_nomiss |
                           2  |   3.18e-15   4.96e-07    -0.00   1.000            0           .
                           3  |   1.58e-15   1.20e-07    -0.00   1.000            0           .
                              |
                          imd |
                           2  |   .0650075   2.25e+07    -0.00   1.000            0           .
                           3  |   .0801625   2.01e+07    -0.00   1.000            0           .
                           4  |   3.31e+15   1.56e+23     0.00   1.000            0           .
             5 most deprived  |   .0591841   2.06e+07    -0.00   1.000            0           .
                              |
           1.htdiag_or_highbp |   6.51e-16   4.68e-08    -0.00   1.000            0           .
1.chronic_respiratory_disease |   6.34e+13   5.94e+22     0.00   1.000            0           .
                              |
                    asthmacat |
                 Yes, no OCS  |   .0571904   6.49e+07    -0.00   1.000            0           .
    1.chronic_cardiac_disease |   1.05e-15   4.04e-07    -0.00   1.000            0           .
                              |
                      diabcat |
         Controlled diabetes  |   2.14e-15   3.32e-07    -0.00   1.000            0           .
       Uncontrolled diabetes  |   4.78e-15   8.61e-07    -0.00   1.000            0           .
  Diabetes, no hba1c measure  |   4.55e-15   4.84e-07    -0.00   1.000            0           .
                              |
            cancer_exhaem_cat |
                   Last year  |          1  (omitted)
                    5+ years  |   2.99e+14   5.64e+23     0.00   1.000            0           .
                              |
              cancer_haem_cat |
                   Last year  |   4.41e+25          .        .       .            .           .
                    5+ years  |   3.08e+24          .        .       .            .           .
                              |
      1.chronic_liver_disease |   2.69e+29          .        .       .            .           .
            1.stroke_dementia |   2.012393   5.25e+09     0.00   1.000            0           .
                1.other_neuro |   1.22e+15          .        .       .            .           .
                              |
                          ckd |
                      No CKD  |          1  (omitted)
           1.organ_transplant |          1  (omitted)
                     1.spleen |   1.32e+22          .        .       .            .           .
           1.ra_sle_psoriasis |    .356079   4.98e+08    -0.00   1.000            0           .
    1.other_immunosuppression |   .0062274          .        .       .            .           .
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agegroup_bmicat_noeth, replace
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agegroup_bmicat_noeth.ster not found)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agegroup_bmicat_noeth.ster saved
. *estat concordance /*c-statistic*/
. }

. else di "WARNING GROUP MODEL DID NOT FIT (OUTCOME `outcome')"

. 
. *Complete case ethnicity model
. basecoxmodel, age("age1 age2 age3")  ethnicity(1)
   1:      0.59 /        1 =       0.5910

. if _rc==0{
. estimates

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
active results
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- no ties

No. of subjects =        8,533                  Number of obs    =       8,533
No. of failures =            0
Time at risk    =       639975
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |          1  (omitted)
                         age2 |          1  (omitted)
                         age3 |          1  (omitted)
                       1.male |          1  (omitted)
                              |
                    obese4cat |
           Obese I (30-34.9)  |          1  (omitted)
          Obese II (35-39.9)  |          1  (omitted)
             Obese III (40+)  |          1  (omitted)
                              |
                 smoke_nomiss |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                              |
                    ethnicity |
                       Mixed  |          1  (omitted)
      Asian or Asian British  |          1  (omitted)
                       Black  |          1  (omitted)
                       Other  |          1  (omitted)
                              |
                          imd |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                           4  |          1  (omitted)
             5 most deprived  |          1  (omitted)
                              |
           1.htdiag_or_highbp |          1  (omitted)
1.chronic_respiratory_disease |          1  (omitted)
                              |
                    asthmacat |
                 Yes, no OCS  |          1  (omitted)
    1.chronic_cardiac_disease |          1  (omitted)
                              |
                      diabcat |
         Controlled diabetes  |          1  (omitted)
       Uncontrolled diabetes  |          1  (omitted)
  Diabetes, no hba1c measure  |          1  (omitted)
                              |
            cancer_exhaem_cat |
                   Last year  |          1  (omitted)
                    5+ years  |          1  (omitted)
                              |
              cancer_haem_cat |
                    5+ years  |          1  (omitted)
      1.chronic_liver_disease |          1  (omitted)
            1.stroke_dementia |          1  (omitted)
                1.other_neuro |          1  (omitted)
                              |
                          ckd |
                      No CKD  |          1  (omitted)
           0.organ_transplant |          1  (omitted)
                     0.spleen |          1  (omitted)
           1.ra_sle_psoriasis |          1  (omitted)
    1.other_immunosuppression |          1  (omitted)
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_CCeth, replace
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCeth.ster not found)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCeth.ster saved
. *estat concordance /*c-statistic*/
.  }

.  else di "WARNING CC ETHNICITY MODEL DID NOT FIT (OUTCOME `outcome')"

. 
.  
. *Model without ethnicity among ethnicity complete cases 
. basecoxmodel, age("age1 age2 age3")  ethnicity(0) if("if ethnicity<.")
   1:      0.69 /        1 =       0.6900

. if _rc==0{
. estimates

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
active results
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Stratified Cox regr. -- no ties

No. of subjects =        8,533                  Number of obs    =       8,533
No. of failures =            0
Time at risk    =       639975
                                                LR chi2(0)       =        0.00
Log likelihood  =            0                  Prob > chi2      =           .

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                         age1 |          1  (omitted)
                         age2 |          1  (omitted)
                         age3 |          1  (omitted)
                       1.male |          1  (omitted)
                              |
                    obese4cat |
           Obese I (30-34.9)  |          1  (omitted)
          Obese II (35-39.9)  |          1  (omitted)
             Obese III (40+)  |          1  (omitted)
                              |
                 smoke_nomiss |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                              |
                          imd |
                           2  |          1  (omitted)
                           3  |          1  (omitted)
                           4  |          1  (omitted)
             5 most deprived  |          1  (omitted)
                              |
           1.htdiag_or_highbp |          1  (omitted)
1.chronic_respiratory_disease |          1  (omitted)
                              |
                    asthmacat |
                 Yes, no OCS  |          1  (omitted)
    1.chronic_cardiac_disease |          1  (omitted)
                              |
                      diabcat |
         Controlled diabetes  |          1  (omitted)
       Uncontrolled diabetes  |          1  (omitted)
  Diabetes, no hba1c measure  |          1  (omitted)
                              |
            cancer_exhaem_cat |
                   Last year  |          1  (omitted)
                    5+ years  |          1  (omitted)
                              |
              cancer_haem_cat |
                    5+ years  |          1  (omitted)
      1.chronic_liver_disease |          1  (omitted)
            1.stroke_dementia |          1  (omitted)
                1.other_neuro |          1  (omitted)
                              |
                          ckd |
                      No CKD  |          1  (omitted)
           0.organ_transplant |          1  (omitted)
                     0.spleen |          1  (omitted)
           1.ra_sle_psoriasis |          1  (omitted)
    1.other_immunosuppression |          1  (omitted)
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_CCnoeth, replace
(note: file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCnoeth.ster not found)
file ./output/models/an_multivariate_cox_models_cpnsdeath_MAINFULLYADJMODEL_agespline_bmicat_CCnoeth.ster saved
. *estat concordance /*c-statistic*/
.  }

.  else di "WARNING CC MODEL (excluding ethnicity) DID NOT FIT (OUTCOME `outcome')"

.  
. /* 
> *PRIMARY MODEL PH TEST 
> estimates use ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJMODEL_agespline_bmicat_noeth
> estat phtest
> */
. ************************************************************************
. * Add IBS 
. 
. * Calculate at 60 days
. *
. *stbrier, bt(60) efron
. 
. /*
> stbrier age1 age2 age3 male i.bmicat i.smoke                                                    ///
>                 resp asthma heart diabetes cancer liver neuro_dis kidney_dis    ///
>                 transplant spleen immunosup hypertension autoimmune sle                 ///
>                 endocrine                                                                                                               ///
>                 , shared(stp) bt(60)                                                                                    ///
>                 ipcw(age1 age2 age3 male i.bmicat i.smoke                                               ///
>                 resp asthma heart diabetes cancer liver neuro_dis kidney_dis    ///
>                 transplant spleen immunosup hypertension autoimmune sle                 ///
>                 endocrine)
> */
. 
. * Simple model just to try:
. /*
> stbrier age1 age2 age3 male                                                                                     ///
>                 , shared(stp) bt(60)                                                                                    ///
>                 ipcw(age1 age2 age3 male)
> */
. ************************************************************************
. 
. 
. * Close log file  (bootstrapping likely to take a while)
. log close
      name:  <unnamed>
       log:  C:\Github\opencorona-risk-factors-research\analysis\output/an_multivariable_cox_models_cpnsdeath.log
  log type:  text
 closed on:  27 Apr 2020, 22:21:48
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
