--------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/kbadhoc_CCbmiANDsmok_cpnsdeath.log
  log type:  text
 opened on:  30 Apr 2020, 23:16:08

. 
. use cr_create_analysis_dataset, clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. replace obese4cat = . if bmicat>=.
(3,763,484 real changes made, 3,763,484 to missing)

. 
. ******************************
. *  Multivariable Cox models  *
. ******************************
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) bp(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke                                 ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         `bp'                                                    ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.chronic_kidney_disease                ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_immunosuppression                       ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. 
. 
. stset stime_`outcome', fail(`outcome') enter(enter_date) origin(enter_date) id(patient_id)
>  

                id:  patient_id
     failure event:  cpnsdeath != 0 & cpnsdeath < .
obs. time interval:  (stime_cpnsdeath[_n-1], stime_cpnsdeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
   17420594  total observations
        466  observations end on or before enter()
------------------------------------------------------------------------------
   17420128  observations remaining, representing
   17420128  subjects
      5,707  failures in single-failure-per-subject data
 1.4615e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        84

. 
. *Age spline model (not adj ethnicity)
. basecoxmodel, age("age1 age2 age3")  bp("i.htdiag_or_highbp") ethnicity(0)
   1:   1909.98 /        1 =    1909.9820

. if _rc==0{
. estimates

--------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   13,468,652                  Number of obs    =  13,468,652
No. of failures =        5,165
Time at risk    =   1129805912
                                                LR chi2(35)      =    15658.24
Log likelihood  =   -60334.144                  Prob > chi2      =      0.0000

-------------------------------------------------------------------------------------------
                       _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
--------------------------+----------------------------------------------------------------
                     age1 |   1.116607   .0321047     3.84   0.000     1.055423    1.181338
                     age2 |   .9852359   .0622108    -0.24   0.814     .8705481    1.115033
                     age3 |   1.002733   .1473322     0.02   0.985     .7518268    1.337374
                   1.male |   2.055581   .0622639    23.79   0.000     1.937097    2.181311
                          |
                obese4cat |
       Obese I (30-34.9)  |   1.318875   .0463396     7.88   0.000     1.231107    1.412899
      Obese II (35-39.9)  |    1.64222   .0840422     9.69   0.000     1.485491    1.815484
         Obese III (40+)  |   2.398635   .1615565    12.99   0.000        2.102    2.737131
                          |
                    smoke |
                  Former  |   1.254617   .0407272     6.99   0.000      1.17728    1.337035
                 Current  |   .9182562   .0557061    -1.41   0.160     .8153153    1.034194
                          |
                      imd |
                       2  |   1.130408   .0535762     2.59   0.010      1.03013    1.240447
                       3  |   1.225537   .0577519     4.32   0.000     1.117415     1.34412
                       4  |   1.487145   .0689251     8.56   0.000     1.358008    1.628562
         5 most deprived  |   1.723805   .0818928    11.46   0.000     1.570544    1.892022
                          |
       1.htdiag_or_highbp |   .9466493   .0323924    -1.60   0.109     .8852435    1.012314
1.chronic_respiratory_d~e |   1.730782   .0606989    15.64   0.000     1.615811    1.853934
                          |
                asthmacat |
             Yes, no OCS  |   1.102495   .0464026     2.32   0.020     1.015198    1.197299
            Yes with OCS  |   1.207819   .0921966     2.47   0.013     1.039985    1.402739
                          |
1.chronic_cardiac_disease |   1.262116   .0389984     7.53   0.000     1.187949    1.340913
                          |
                  diabcat |
     Controlled diabetes  |   1.477824   .0516519    11.17   0.000     1.379978    1.582608
   Uncontrolled diabetes  |   2.308305   .0989546    19.51   0.000     2.122282    2.510633
Diabetes, no hba1c mea..  |   1.837688   .1280851     8.73   0.000     1.603038    2.106686
                          |
        cancer_exhaem_cat |
               Last year  |   1.472451    .150744     3.78   0.000     1.204753    1.799631
           2-5 years ago  |   1.192243   .0804872     2.60   0.009     1.044482    1.360907
                5+ years  |   .9561335   .0450615    -0.95   0.341     .8717709     1.04866
                          |
          cancer_haem_cat |
               Last year  |    3.64864   .7049259     6.70   0.000     2.498485    5.328257
           2-5 years ago  |   2.986269   .3550896     9.20   0.000     2.365455    3.770016
                5+ years  |   1.868845   .1951892     5.99   0.000     1.522897     2.29338
                          |
  1.chronic_liver_disease |   1.582687   .1597279     4.55   0.000     1.298644    1.928857
        1.stroke_dementia |   1.777375   .0673003    15.19   0.000     1.650244    1.914299
            1.other_neuro |   2.340993    .146584    13.58   0.000     2.070623    2.646665
 1.chronic_kidney_disease |   1.675196   .0540577    15.99   0.000     1.572526     1.78457
       1.organ_transplant |   4.406913    .661443     9.88   0.000     3.283793     5.91416
                 1.spleen |   1.235522   .2845739     0.92   0.358     .7866761    1.940462
       1.ra_sle_psoriasis |   1.194346   .0575576     3.69   0.000     1.086699    1.312657
1.other_immunosuppression |   1.524767   .2805229     2.29   0.022     1.063167    2.186782
-------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/kbadhoc_CCbmiANDsmok_`outcome', replace
(note: file ./output/models/kbadhoc_CCbmiANDsmok_cpnsdeath.ster not found)
file ./output/models/kbadhoc_CCbmiANDsmok_cpnsdeath.ster saved
. *estat concordance /*c-statistic*/
. }

. else di "WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME `outcome')"

. 
. log close
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/kbadhoc_CCbmiANDsmok_cpnsdeath.log
  log type:  text
 closed on:  30 Apr 2020, 23:53:02
--------------------------------------------------------------------------------------------
. 
. *Age spline model (not adj ethnicity)
. basecoxmodel, age("ib3.agegroup")  bp("i.htdiag_or_highbp") ethnicity(0)
   1:   1901.03 /        1 =    1901.0260

. if _rc==0{
. estimates

--------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   13,468,652                  Number of obs    =  13,468,652
No. of failures =        5,165
Time at risk    =   1129805912
                                                LR chi2(37)      =    15172.23
Log likelihood  =   -60577.146                  Prob > chi2      =      0.0000

-------------------------------------------------------------------------------------------
                       _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
--------------------------+----------------------------------------------------------------
                 agegroup |
                  18-<40  |   .0878076   .0166258   -12.85   0.000     .0605847    .1272627
                  40-<50  |   .3140743   .0408517    -8.90   0.000     .2433977    .4052736
                  60-<70  |   2.142463   .1514035    10.78   0.000     1.865352    2.460742
                  70-<80  |   4.884999   .3221256    24.05   0.000     4.292741    5.558969
                     80+  |    12.8141   .8600139    38.00   0.000     11.23466    14.61559
                          |
                   1.male |   1.958861   .0590276    22.31   0.000     1.846519    2.078037
                          |
                obese4cat |
       Obese I (30-34.9)  |   1.236497   .0431658     6.08   0.000     1.154723    1.324062
      Obese II (35-39.9)  |   1.506072   .0766361     8.05   0.000     1.363116    1.664022
         Obese III (40+)  |   2.157033   .1445422    11.47   0.000     1.891551    2.459776
                          |
                    smoke |
                  Former  |   1.262228   .0410186     7.17   0.000      1.18434    1.345238
                 Current  |   .8673738   .0524723    -2.35   0.019     .7703931     .976563
                          |
                      imd |
                       2  |   1.132517   .0536766     2.63   0.009     1.032051    1.242763
                       3  |   1.227264   .0578456     4.34   0.000     1.118968    1.346042
                       4  |   1.486541   .0689392     8.55   0.000     1.357381     1.62799
         5 most deprived  |   1.715714   .0815517    11.36   0.000     1.563095    1.883235
                          |
       1.htdiag_or_highbp |   .9818403   .0336794    -0.53   0.593     .9179999     1.05012
1.chronic_respiratory_d~e |   1.728536   .0607565    15.57   0.000     1.613465    1.851814
                          |
                asthmacat |
             Yes, no OCS  |   1.083025   .0455694     1.90   0.058      .997294    1.176125
            Yes with OCS  |   1.181906   .0901952     2.19   0.029     1.017712     1.37259
                          |
1.chronic_cardiac_disease |   1.306006   .0404477     8.62   0.000     1.229088    1.387738
                          |
                  diabcat |
     Controlled diabetes  |    1.45624   .0510127    10.73   0.000     1.359612    1.559735
   Uncontrolled diabetes  |   2.219489   .0951725    18.59   0.000     2.040577    2.414086
Diabetes, no hba1c mea..  |   1.890671   .1318215     9.14   0.000     1.649181    2.167521
                          |
        cancer_exhaem_cat |
               Last year  |   1.469429   .1504379     3.76   0.000     1.202275    1.795946
           2-5 years ago  |    1.18599   .0800919     2.53   0.012     1.038958     1.35383
                5+ years  |   .9754374   .0459978    -0.53   0.598     .8893242    1.069889
                          |
          cancer_haem_cat |
               Last year  |   3.585442   .6926733     6.61   0.000     2.455267    5.235845
           2-5 years ago  |   2.899699   .3448415     8.95   0.000     2.296811    3.660839
                5+ years  |   1.852144    .193459     5.90   0.000     1.509266    2.272919
                          |
  1.chronic_liver_disease |   1.536272   .1548269     4.26   0.000     1.260908    1.871773
        1.stroke_dementia |   1.860589    .070431    16.40   0.000     1.727543    2.003881
            1.other_neuro |   2.291809    .143616    13.23   0.000     2.026927    2.591307
 1.chronic_kidney_disease |   1.864325   .0591783    19.62   0.000     1.751872    1.983997
       1.organ_transplant |   4.009993   .6013233     9.26   0.000     2.988827    5.380053
                 1.spleen |   1.209581   .2785724     0.83   0.409     .7701917    1.899638
       1.ra_sle_psoriasis |   1.175142   .0566235     3.35   0.001     1.069241    1.291532
1.other_immunosuppression |   1.444939   .2657189     2.00   0.045     1.007666    2.071964
-------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/kbadhoc_CCbmiANDsmokAGEGP_`outcome', replace
(note: file ./output/models/kbadhoc_CCbmiANDsmokAGEGP_.ster not found)
file ./output/models/kbadhoc_CCbmiANDsmokAGEGP_.ster saved
. *estat concordance /*c-statistic*/
. }

. 
. log close
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/kbadhoc_CCbmiANDsmok_.log
  log type:  text
 closed on:   1 May 2020, 00:41:49
--------------------------------------------------------------------------------------------