--------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/kbadhoc_sensanal_earliercensoring_c
> pnsdeath.log
  log type:  text
 opened on:  30 Apr 2020, 20:42:14

. 
. use "cr_create_analysis_dataset.dta", clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. **************************   INPUT REQUIRED   *********************************
. 
. global cpnsdeathcensor          = "06/04/2020"

. 
. *******************************************************************************
. 
. replace cpnsdeathcensor_date            = date("$cpnsdeathcensor",              "DMY")
(17,420,594 real changes made)

. replace stime_cpnsdeath         = min(cpnsdeathcensor_date,     died_date_cpns, died_date_
> ons)
(17,385,156 real changes made)

. replace cpnsdeath               = 0 if (died_date_cpns          > cpnsdeathcensor_date) 
(3,476 real changes made)

. 
. 
. 
. ******************************
. *  Multivariable Cox models  *
. ******************************
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) bp(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         `bp'                                                    ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.chronic_kidney_disease                ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_immunosuppression                       ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. 
. 
. stset stime_`outcome', fail(`outcome') enter(enter_date) origin(enter_date) id(patient_id)
>  

                id:  patient_id
     failure event:  cpnsdeath != 0 & cpnsdeath < .
obs. time interval:  (stime_cpnsdeath[_n-1], stime_cpnsdeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
   17420594  total observations
        466  observations end on or before enter()
------------------------------------------------------------------------------
   17420128  observations remaining, representing
   17420128  subjects
      2,231  failures in single-failure-per-subject data
 1.1313e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        65

. 
. *Age spline model (not adj ethnicity)
. basecoxmodel, age("age1 age2 age3")  bp("i.htdiag_or_highbp") ethnicity(0)
   1:   3987.88 /        1 =    3987.8790

. if _rc==0{
. estimates

--------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   17,284,549                  Number of obs    =  17,284,549
No. of failures =        2,218
Time at risk    =   1122451703
                                                LR chi2(35)      =     7510.17
Log likelihood  =   -26066.994                  Prob > chi2      =      0.0000

-------------------------------------------------------------------------------------------
                       _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
--------------------------+----------------------------------------------------------------
                     age1 |   1.077225   .0380849     2.10   0.035     1.005107    1.154517
                     age2 |   1.096841   .0888651     1.14   0.254     .9357933    1.285604
                     age3 |   .7596934   .1459289    -1.43   0.152     .5213528    1.106993
                   1.male |   2.165086   .1009862    16.56   0.000     1.975934    2.372344
                          |
                obese4cat |
       Obese I (30-34.9)  |   1.395381   .0753249     6.17   0.000     1.255289    1.551108
      Obese II (35-39.9)  |   1.613264   .1303073     5.92   0.000     1.377057    1.889988
         Obese III (40+)  |   2.427092   .2545819     8.45   0.000     1.976069    2.981057
                          |
             smoke_nomiss |
                  Former  |    1.34519   .0670767     5.95   0.000     1.219942    1.483297
                 Current  |   .8635583    .082056    -1.54   0.123     .7168195    1.040336
                          |
                      imd |
                       2  |   1.009555   .0710072     0.14   0.892     .8795501    1.158776
                       3  |   1.046206    .073753     0.64   0.522     .9111947    1.201222
                       4  |    1.28719     .08875     3.66   0.000     1.124484    1.473438
         5 most deprived  |   1.481021   .1057667     5.50   0.000     1.287576    1.703529
                          |
       1.htdiag_or_highbp |   .9448153   .0488913    -1.10   0.273     .8536893    1.045668
1.chronic_respiratory_d~e |   1.934541    .102178    12.49   0.000     1.744293    2.145539
                          |
                asthmacat |
             Yes, no OCS  |   1.150236   .0735395     2.19   0.029     1.014766    1.303791
            Yes with OCS  |   1.362547   .1511705     2.79   0.005     1.096259    1.693518
                          |
1.chronic_cardiac_disease |   1.328564   .0629185     6.00   0.000     1.210796    1.457786
                          |
                  diabcat |
     Controlled diabetes  |   1.512934   .0818845     7.65   0.000     1.360662    1.682246
   Uncontrolled diabetes  |   2.581421   .1666224    14.69   0.000     2.274661    2.929552
Diabetes, no hba1c mea..  |   1.696184   .1891239     4.74   0.000     1.363214    2.110482
                          |
        cancer_exhaem_cat |
               Last year  |   1.450239   .2294239     2.35   0.019     1.063609    1.977413
           2-5 years ago  |   1.365072   .1323166     3.21   0.001     1.128882    1.650679
                5+ years  |   .9119369   .0674967    -1.25   0.213     .7887937    1.054305
                          |
          cancer_haem_cat |
               Last year  |   2.526279   .8955771     2.61   0.009     1.261033    5.060996
           2-5 years ago  |   3.537456   .5878529     7.60   0.000     2.554105    4.899405
                5+ years  |   1.634569   .2757037     2.91   0.004     1.174439    2.274971
                          |
  1.chronic_liver_disease |   1.836569   .2667498     4.19   0.000     1.381579    2.441399
        1.stroke_dementia |   1.628402   .0974815     8.15   0.000     1.448124    1.831122
            1.other_neuro |   2.203608   .2183107     7.98   0.000     1.814705    2.675855
 1.chronic_kidney_disease |   1.705104   .0840904    10.82   0.000     1.548005    1.878146
       1.organ_transplant |   2.620844   .7413058     3.41   0.001     1.505493    4.562507
                 1.spleen |   1.849582   .5369383     2.12   0.034      1.04705    3.267229
       1.ra_sle_psoriasis |   1.315661   .0935028     3.86   0.000      1.14459    1.512301
1.other_immunosuppression |    2.01146   .4922797     2.86   0.004     1.245061    3.249618
-------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/kbadhoc_sensanal_earliercensoring_`outcome', replace
(note: file ./output/models/kbadhoc_sensanal_earliercensoring_cpnsdeath.ster not found)
file ./output/models/kbadhoc_sensanal_earliercensoring_cpnsdeath.ster saved
. *estat concordance /*c-statistic*/
. }

. 
. estat phtest, d

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      age1        |      0.00155         0.00        1         0.9438
      age2        |     -0.00760         0.12        1         0.7290
      age3        |      0.01059         0.23        1         0.6289
      0b.male     |            .            .        1             .
      1.male      |      0.02485         1.39        1         0.2392
      1b.obese4cat|            .            .        1             .
      2.obese4cat |      0.00783         0.14        1         0.7112
      3.obese4cat |      0.02764         1.68        1         0.1947
      4.obese4cat |      0.02556         1.44        1         0.2302
      1b.smoke_n~s|            .            .        1             .
      2.smoke_no~s|      0.02476         1.34        1         0.2466
      3.smoke_no~s|      0.01360         0.42        1         0.5191
      1b.imd      |            .            .        1             .
      2.imd       |      0.01974         0.86        1         0.3524
      3.imd       |      0.01212         0.32        1         0.5708
      4.imd       |      0.03387         2.51        1         0.1130
      5.imd       |      0.02835         1.75        1         0.1854
      0b.htdiag_~p|            .            .        1             .
      1.htdiag_o~p|     -0.01008         0.24        1         0.6246
      0b.c~respi~e|            .            .        1             .
      1.c~respir~e|     -0.01785         0.77        1         0.3804
      1b.asthmacat|            .            .        1             .
      2.asthmacat |     -0.00644         0.09        1         0.7622
      3.asthmacat |      0.00126         0.00        1         0.9517
      0b.c~cardi~e|            .            .        1             .
      1.c~cardia~e|     -0.06325         9.20        1         0.0024
      1b.diabcat  |            .            .        1             .
      2.diabcat   |     -0.02782         1.74        1         0.1872
      3.diabcat   |     -0.02421         1.34        1         0.2476
      4.diabcat   |     -0.00018         0.00        1         0.9931
      1b.c~exhae~t|            .            .        1             .
      2.cancer_e~t|     -0.03463         2.67        1         0.1025
      3.cancer_e~t|     -0.00143         0.00        1         0.9463
      4.cancer_e~t|     -0.00420         0.04        1         0.8432
      1b.cancer_h~|            .            .        1             .
      2.cancer_h~t|     -0.02593         1.49        1         0.2216
      3.cancer_h~t|      0.01022         0.23        1         0.6290
      4.cancer_h~t|     -0.01187         0.31        1         0.5749
      0b.c~liver~e|            .            .        1             .
      1.c~liver_~e|      0.00299         0.02        1         0.8855
      0b.stroke_~a|            .            .        1             .
      1.stroke_d~a|      0.02214         1.16        1         0.2812
      0b.other_n~o|            .            .        1             .
      1.other_ne~o|     -0.01091         0.28        1         0.5992
      0b.c~kidne~e|            .            .        1             .
      1.c~kidney~e|     -0.00726         0.14        1         0.7131
      0b.organ_t~t|            .            .        1             .
      1.organ_tr~t|      0.03903         3.51        1         0.0611
      0b.spleen   |            .            .        1             .
      1.spleen    |      0.01063         0.25        1         0.6158
      0b.ra_sle_~s|            .            .        1             .
      1.ra_sle_p~s|     -0.00827         0.15        1         0.6962
      0b.other_i~n|            .            .        1             .
      1.other_im~n|      0.01447         0.46        1         0.4976
      ------------+---------------------------------------------------
      global test |                     33.38       35         0.5462
      ----------------------------------------------------------------

. 
. log close
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/kbadhoc_sensanal_earliercensoring_c
> pnsdeath.log
  log type:  text
 closed on:  30 Apr 2020, 22:42:15
--------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/kbadhoc_sensanal_earliercensoring_c
> pnsdeath.log
  log type:  text
 opened on:   1 May 2020, 00:12:45

. 
. *Age spline model (not adj ethnicity)
. basecoxmodel, age("ib3.agegroup")  bp("i.htdiag_or_highbp") ethnicity(0)
   1:   2510.36 /        1 =    2510.3570

. if _rc==0{
. estimates

--------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   17,284,549                  Number of obs    =  17,284,549
No. of failures =        2,218
Time at risk    =   1122451703
                                                LR chi2(37)      =     7319.21
Log likelihood  =   -26162.471                  Prob > chi2      =      0.0000

-------------------------------------------------------------------------------------------
                       _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
--------------------------+----------------------------------------------------------------
                 agegroup |
                  18-<40  |   .0790565   .0217059    -9.24   0.000     .0461562    .1354081
                  40-<50  |   .3155161    .061988    -5.87   0.000     .2146792    .4637172
                  60-<70  |   2.389111   .2607868     7.98   0.000     1.928955    2.959037
                  70-<80  |   5.673357    .579067    17.01   0.000     4.644723    6.929794
                     80+  |   13.56513   1.411632    25.06   0.000     11.06229    16.63423
                          |
                   1.male |    2.06891   .0960381    15.66   0.000     1.888987     2.26597
                          |
                obese4cat |
       Obese I (30-34.9)  |   1.313345   .0704451     5.08   0.000     1.182285    1.458934
      Obese II (35-39.9)  |   1.488999   .1196506     4.95   0.000     1.272023    1.742986
         Obese III (40+)  |   2.203059   .2300126     7.57   0.000     1.795377    2.703315
                          |
             smoke_nomiss |
                  Former  |   1.349676   .0673827     6.01   0.000     1.223864    1.488421
                 Current  |   .8197666   .0776842    -2.10   0.036     .6808118    .9870822
                          |
                      imd |
                       2  |   1.011254    .071128     0.16   0.874     .8810279    1.160728
                       3  |   1.047641    .073873     0.66   0.509      .912412    1.202912
                       4  |   1.286975   .0887955     3.66   0.000     1.124193    1.473327
         5 most deprived  |   1.475497   .1054368     5.44   0.000     1.282664    1.697321
                          |
       1.htdiag_or_highbp |   .9747048   .0505754    -0.49   0.621     .8804528    1.079046
1.chronic_respiratory_d~e |    1.93019   .1021853    12.42   0.000     1.739951    2.141229
                          |
                asthmacat |
             Yes, no OCS  |    1.13174   .0723316     1.94   0.053      .998493     1.28277
            Yes with OCS  |   1.336219   .1482112     2.61   0.009     1.075137    1.660701
                          |
1.chronic_cardiac_disease |   1.369559   .0650203     6.62   0.000     1.247871    1.503114
                          |
                  diabcat |
     Controlled diabetes  |   1.489427   .0807704     7.35   0.000     1.339242    1.656453
   Uncontrolled diabetes  |   2.483737    .160318    14.09   0.000     2.188583    2.818696
Diabetes, no hba1c mea..  |   1.742201   .1943072     4.98   0.000     1.400116    2.167867
                          |
        cancer_exhaem_cat |
               Last year  |    1.44425   .2284926     2.32   0.020     1.059193     1.96929
           2-5 years ago  |   1.355865   .1314769     3.14   0.002     1.121183    1.639671
                5+ years  |   .9289407   .0687903    -1.00   0.320     .8034419    1.074043
                          |
          cancer_haem_cat |
               Last year  |   2.478055   .8784577     2.56   0.010     1.236985    4.964294
           2-5 years ago  |   3.438428   .5714817     7.43   0.000     2.482484    4.762482
                5+ years  |   1.619335   .2731466     2.86   0.004     1.163476    2.253803
                          |
  1.chronic_liver_disease |   1.784331   .2588781     3.99   0.000     1.342702    2.371217
        1.stroke_dementia |   1.699956   .1017487     8.86   0.000     1.511785    1.911548
            1.other_neuro |   2.159536    .214106     7.77   0.000      1.77815    2.622722
 1.chronic_kidney_disease |   1.883651   .0914836    13.04   0.000     1.712617    2.071767
       1.organ_transplant |   2.404159   .6795973     3.10   0.002     1.381495     4.18386
                 1.spleen |   1.814154   .5265959     2.05   0.040     1.027058    3.204447
       1.ra_sle_psoriasis |   1.296017   .0920951     3.65   0.000      1.12752    1.489694
1.other_immunosuppression |   1.912269   .4677719     2.65   0.008     1.183945    3.088635
-------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/kbadhoc_sensanal_earliercensoring_AGEGP_`outcome', replace
(note: file ./output/models/kbadhoc_sensanal_earliercensoring_AGEGP_cpnsdeath.ster not found
> )
file ./output/models/kbadhoc_sensanal_earliercensoring_AGEGP_cpnsdeath.ster saved
. }

. 
. log close
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/kbadhoc_sensanal_earliercensoring_c
> pnsdeath.log
  log type:  text
 closed on:   1 May 2020, 00:54:39
--------------------------------------------------------------------------------------------
