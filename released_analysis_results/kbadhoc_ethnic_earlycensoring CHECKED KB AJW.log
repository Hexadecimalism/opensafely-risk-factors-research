--------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/kbadhoc_ethnic_earlycensoring.log
  log type:  text
 opened on:   1 May 2020, 00:31:08

. 
. use "cr_create_analysis_dataset.dta", clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. **************************   INPUT REQUIRED   *********************************
. 
. global cpnsdeathcensor          = "06/04/2020"

. 
. *******************************************************************************
. 
. replace cpnsdeathcensor_date            = date("$cpnsdeathcensor",              "DMY")
(17,420,594 real changes made)

. replace stime_cpnsdeath         = min(cpnsdeathcensor_date,     died_date_cpns, died_date_
> ons)
(17,385,156 real changes made)

. replace cpnsdeath               = 0 if (died_date_cpns          > cpnsdeathcensor_date) 
(3,476 real changes made)

. 
. 
. 
. ******************************
. *  Multivariable Cox models  *
. ******************************
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) bp(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         `bp'                                                    ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.chronic_kidney_disease                ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_immunosuppression                       ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. 
. 
. stset stime_`outcome', fail(`outcome') enter(enter_date) origin(enter_date) id(patient_id)
>  

                id:  patient_id
     failure event:  cpnsdeath != 0 & cpnsdeath < .
obs. time interval:  (stime_cpnsdeath[_n-1], stime_cpnsdeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
   17420594  total observations
        466  observations end on or before enter()
------------------------------------------------------------------------------
   17420128  observations remaining, representing
   17420128  subjects
      2,231  failures in single-failure-per-subject data
 1.1313e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        65

. 
. *Complete case ethnicity model
. basecoxmodel, age("age1 age2 age3") bp("i.htdiag_or_highbp") ethnicity(1)
   1:   1843.44 /        1 =    1843.4400

. if _rc==0{
. estimates

--------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   12,715,040                  Number of obs    =  12,715,040
No. of failures =        1,648
Time at risk    =    825745027
                                                LR chi2(39)      =     5596.88
Log likelihood  =   -18926.507                  Prob > chi2      =      0.0000

-------------------------------------------------------------------------------------------
                       _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
--------------------------+----------------------------------------------------------------
                     age1 |    1.08216   .0468776     1.82   0.068      .994074    1.178052
                     age2 |   1.095069   .1068208     0.93   0.352     .9045018    1.325787
                     age3 |   .7525738   .1728271    -1.24   0.216     .4798134    1.180391
                   1.male |   2.042957   .1102134    13.24   0.000     1.837971    2.270805
                          |
                obese4cat |
       Obese I (30-34.9)  |   1.403743   .0870134     5.47   0.000     1.243152    1.585078
      Obese II (35-39.9)  |    1.55537   .1468267     4.68   0.000     1.292648    1.871488
         Obese III (40+)  |   2.493606   .2987844     7.63   0.000     1.971681     3.15369
                          |
             smoke_nomiss |
                  Former  |   1.411316   .0835421     5.82   0.000     1.256718    1.584932
                 Current  |   .9414329   .1019679    -0.56   0.577     .7613679    1.164084
                          |
                ethnicity |
                   Mixed  |   1.134101   .3458262     0.41   0.680     .6238654    2.061637
  Asian or Asian British  |   1.800863   .1666012     6.36   0.000     1.502223    2.158872
                   Black  |   1.920245   .2455438     5.10   0.000     1.494557    2.467179
                   Other  |   1.881739   .3308743     3.60   0.000     1.333181    2.656011
                          |
                      imd |
                       2  |   1.056355   .0884608     0.65   0.513     .8964555    1.244774
                       3  |   1.000052   .0849359     0.00   1.000     .8466988    1.181181
                       4  |   1.235273   .1015438     2.57   0.010     1.051456    1.451225
         5 most deprived  |   1.376815   .1166196     3.78   0.000     1.166209    1.625453
                          |
       1.htdiag_or_highbp |   .9755687   .0594483    -0.41   0.685     .8657413    1.099329
1.chronic_respiratory_d~e |   1.980243   .1204122    11.24   0.000      1.75776    2.230885
                          |
                asthmacat |
             Yes, no OCS  |   1.023365   .0774726     0.31   0.760     .8822494    1.187052
            Yes with OCS  |   1.430147   .1718801     2.98   0.003     1.130004     1.81001
                          |
1.chronic_cardiac_disease |   1.399747   .0769099     6.12   0.000      1.25684    1.558904
                          |
                  diabcat |
     Controlled diabetes  |   1.471372   .0924732     6.14   0.000     1.300846    1.664252
   Uncontrolled diabetes  |   2.395031   .1805475    11.59   0.000     2.066065    2.776377
Diabetes, no hba1c mea..  |   1.677843   .2115747     4.10   0.000     1.310435    2.148261
                          |
        cancer_exhaem_cat |
               Last year  |   1.512241   .2753113     2.27   0.023     1.058414    2.160661
           2-5 years ago  |   1.412127   .1586892     3.07   0.002     1.132972    1.760064
                5+ years  |   .9800371   .0833229    -0.24   0.813     .8296086    1.157742
                          |
          cancer_haem_cat |
               Last year  |   2.962131   1.123188     2.86   0.004     1.408782    6.228235
           2-5 years ago  |    4.00257      .7279     7.63   0.000      2.80247    5.716588
                5+ years  |   1.657267   .3229249     2.59   0.010     1.131183    2.428021
                          |
  1.chronic_liver_disease |    1.81115   .2980289     3.61   0.000     1.311859     2.50047
        1.stroke_dementia |   1.625712   .1132291     6.98   0.000     1.418268    1.863497
            1.other_neuro |   1.967211   .2369812     5.62   0.000     1.553497    2.491101
 1.chronic_kidney_disease |   1.754169   .1008765     9.77   0.000      1.56719    1.963456
       1.organ_transplant |   2.444121   .7888386     2.77   0.006     1.298368     4.60095
                 1.spleen |   2.188071   .6642228     2.58   0.010     1.206886    3.966951
       1.ra_sle_psoriasis |   1.298946   .1074232     3.16   0.002     1.104578    1.527516
1.other_immunosuppression |   1.960541   .5299939     2.49   0.013     1.154171    3.330286
-------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/kbadhoc_ethnic_earlycensoring, replace
(note: file ./output/models/kbadhoc_ethnic_earlycensoring.ster not found)
file ./output/models/kbadhoc_ethnic_earlycensoring.ster saved
. *estat concordance /*c-statistic*/
.  }

.  else di "WARNING CC ETHNICITY MODEL DID NOT FIT (OUTCOME `outcome')"

.  
. 
. 
. log close
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/kbadhoc_ethnic_earlycensoring.log
  log type:  text
 closed on:   1 May 2020, 01:07:31
--------------------------------------------------------------------------------------------
