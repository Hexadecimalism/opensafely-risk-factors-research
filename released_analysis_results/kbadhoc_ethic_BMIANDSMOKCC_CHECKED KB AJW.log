--------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/kbadhoc_ethic_BMIANDSMOKCC.log
  log type:  text
 opened on:   1 May 2020, 00:33:37

. 
. use cr_create_analysis_dataset, clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. replace obese4cat = . if bmicat>=.
(3,763,484 real changes made, 3,763,484 to missing)

. 
. ******************************
. *  Multivariable Cox models  *
. ******************************
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) bp(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke                         ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         `bp'                                                    ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.chronic_kidney_disease                ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         i.other_immunosuppression                       ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. 
. 
. stset stime_`outcome', fail(`outcome') enter(enter_date) origin(enter_date) id(patient_id)
>  

                id:  patient_id
     failure event:  cpnsdeath != 0 & cpnsdeath < .
obs. time interval:  (stime_cpnsdeath[_n-1], stime_cpnsdeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
   17420594  total observations
        466  observations end on or before enter()
------------------------------------------------------------------------------
   17420128  observations remaining, representing
   17420128  subjects
      5,707  failures in single-failure-per-subject data
 1.4615e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        84

. 
. *Complete case ethnicity model
. basecoxmodel, age("age1 age2 age3") bp("i.htdiag_or_highbp") ethnicity(1)
   1:   1584.96 /        1 =    1584.9650

. if _rc==0{
. estimates

--------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   10,727,177                  Number of obs    =  10,727,177
No. of failures =        3,933
Time at risk    =    899946958
                                                LR chi2(39)      =    12321.89
Log likelihood  =   -45007.377                  Prob > chi2      =      0.0000

-------------------------------------------------------------------------------------------
                       _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
--------------------------+----------------------------------------------------------------
                     age1 |   1.100793   .0351182     3.01   0.003      1.03407    1.171821
                     age2 |   1.027879   .0722522     0.39   0.696     .8955891    1.179709
                     age3 |   .9006458   .1475383    -0.64   0.523     .6533041    1.241631
                   1.male |   1.979957    .068595    19.72   0.000     1.849977    2.119071
                          |
                obese4cat |
       Obese I (30-34.9)  |   1.345298    .054047     7.38   0.000     1.243431     1.45551
      Obese II (35-39.9)  |   1.704068   .0991969     9.16   0.000     1.520327    1.910015
         Obese III (40+)  |   2.432866   .1892245    11.43   0.000     2.088878    2.833501
                          |
                    smoke |
                  Former  |   1.332996   .0506168     7.57   0.000     1.237391    1.435988
                 Current  |   .9782332   .0676345    -0.32   0.750     .8542614    1.120196
                          |
                ethnicity |
                   Mixed  |   1.580414   .2750227     2.63   0.009     1.123686    2.222779
  Asian or Asian British  |   1.675606   .1052861     8.21   0.000      1.48145    1.895208
                   Black  |   1.685276   .1523365     5.77   0.000     1.411655    2.011932
                   Other  |   1.458547   .1970181     2.79   0.005     1.119287    1.900638
                          |
                      imd |
                       2  |   1.167614   .0655514     2.76   0.006     1.045952    1.303428
                       3  |   1.237189   .0690496     3.81   0.000     1.108994    1.380203
                       4  |   1.507617   .0821525     7.53   0.000     1.354901    1.677546
         5 most deprived  |   1.672203   .0934366     9.20   0.000     1.498742    1.865739
                          |
       1.htdiag_or_highbp |   .9624024   .0380377    -0.97   0.332     .8906644    1.039918
1.chronic_respiratory_d~e |   1.746238   .0700338    13.90   0.000      1.61423    1.889041
                          |
                asthmacat |
             Yes, no OCS  |   1.020522   .0498764     0.42   0.678     .9273023    1.123114
            Yes with OCS  |   1.179307   .1008573     1.93   0.054     .9973099    1.394517
                          |
1.chronic_cardiac_disease |   1.267895   .0451498     6.67   0.000      1.18242    1.359548
                          |
                  diabcat |
     Controlled diabetes  |   1.457782   .0588461     9.34   0.000      1.34689    1.577804
   Uncontrolled diabetes  |   2.184237    .108635    15.71   0.000     1.981365    2.407881
Diabetes, no hba1c mea..  |   1.917401   .1479003     8.44   0.000      1.64837     2.23034
                          |
        cancer_exhaem_cat |
               Last year  |   1.643578   .1853584     4.41   0.000     1.317631    2.050154
           2-5 years ago  |   1.223994   .0951288     2.60   0.009     1.051052    1.425393
                5+ years  |   1.025152   .0548249     0.46   0.642     .9231372    1.138441
                          |
          cancer_haem_cat |
               Last year  |    3.34555   .7704014     5.24   0.000     2.130374    5.253868
           2-5 years ago  |   3.190603    .423004     8.75   0.000     2.460493    4.137361
                5+ years  |   1.818173   .2215779     4.91   0.000      1.43186    2.308712
                          |
  1.chronic_liver_disease |   1.622197   .1814749     4.32   0.000     1.302806    2.019889
        1.stroke_dementia |   1.731928   .0760185    12.51   0.000     1.589163    1.887518
            1.other_neuro |   2.360711   .1691559    11.99   0.000     2.051399     2.71666
 1.chronic_kidney_disease |   1.727242    .064187    14.71   0.000      1.60591    1.857741
       1.organ_transplant |    4.64292   .7578767     9.41   0.000     3.371687    6.393449
                 1.spleen |   1.252862   .3248082     0.87   0.385     .7537493    2.082475
       1.ra_sle_psoriasis |   1.129678   .0639329     2.15   0.031     1.011072    1.262198
1.other_immunosuppression |   1.574867   .3118758     2.29   0.022     1.068262    2.321721
-------------------------------------------------------------------------------------------
                                                             Stratified by stp
. estimates save ./output/models/kbadhoc_ethic_BMIANDSMOKCC, replace
(note: file ./output/models/kbadhoc_ethic_BMIANDSMOKCC.ster not found)
file ./output/models/kbadhoc_ethic_BMIANDSMOKCC.ster saved
. *estat concordance /*c-statistic*/
.  }

.  else di "WARNING CC ETHNICITY MODEL DID NOT FIT (OUTCOME `outcome')"

. 
.  
. 
. 
. log close
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/kbadhoc_ethic_BMIANDSMOKCC.log
  log type:  text
 closed on:   1 May 2020, 01:05:07
--------------------------------------------------------------------------------------------
