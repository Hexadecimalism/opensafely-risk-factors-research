--------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/an_checkassumptions_3_1.log
  log type:  text
 opened on:  30 Apr 2020, 19:36:09

. 
. * Load user written functions
. do Calibration_parameter_nlsolution.do  

. ********************************************************************************
. *
. *       Do-file:                Calibration_parameter_nlsolution.do
. *
. *       Project:                Risk factors for poor outcomes in Covid-19; Ethnicity MNAR
. *
. *       Programmed by:  Fizz
. *
. *       Data used:              None
. *
. *       Data created:   None
. *
. *       Other output:   User-written program:  nlnle2 and a wrapper, nlnle2_wrap
. *
. ********************************************************************************
. *
. *       Purpose:                This do-file creates a program whose purpose is to solve
. *                                       a specific set of non-linear equations.
. *  
. ********************************************************************************
. *       
. *       Input parameters: The following globals need to be defined:
. *
. *               Number missing ethnicity, $Nmis 
. *               Probability of missing/observing ethnicity, $r0star and $r1star
. *               Probability of each ethnicity among observed, $Eth1obsstar, 
. *                                               $Eth2obsstar, $Eth3obsstar, $Eth4obsstar
. *               Marginal probability of ethnicity (external data), $Eth1, $Eth2, $Eth3, $E
> th4
. *
. *       Input variables: The following variables need to be in memory:
. *
. *               r - indicator of Ethnicity being observed (1=yes, 0=no)
. *               lp1 - linear predictor from mlogit model to impute ethnicity among r=1, Bl
> ack
. *               lp2 - linear predictor from mlogit model to impute ethnicity among r=1, As
> ian
. *               lp3 - linear predictor from mlogit model to impute ethnicity among r=1, Mi
> xed
. *               lp4 - linear predictor from mlogit model to impute ethnicity among r=1, Ot
> her
. *
. *
. *       ASSUMPTIONS:    This is a complete case sample, other than ethnicity.
. *                                       Ethnicity is White, Black, Asian, Mixed, other
. *                                       (same order, coding (1, 2, 3, 4, 5), labelling)
. *  
. ********************************************************************************
. 
. 
. ********************************************************************************
. *       
. *       To run alone:   
. *                       matrix mat = (1,0,0,0)
. *                       nlnle2 y lp1 lp2 lp3 lp4 r, at(mat)
. *
. *       Use in MI process:
. *                       nl nle2 @ y lp1 lp2 lp3 lp4 ethnicity, ///
> *                                       parameters(A B C D) initial(A 2 B 2 C 2 D 2)
. *
. ********************************************************************************
. 
. 
. *******************************************
. *  Program to solve non-linear equations  *
. *******************************************
. 
. 
. cap prog drop nlnle2

. program nlnle2
  1. syntax varlist(min=6 max=6) [if], at(name)
  2. 
.         * Pick up inputs
.         tokenize `varlist'
  3.         local y   `1'
  4.         local lp1 `2'
  5.         local lp2 `3'
  6.         local lp3 `4'
  7.         local lp4 `5'
  8.         local r   `6'
  9.         
.         * Pick up current parameter values (Black/Asian/Mixed/Other, respectively)
.         tempname A B C D
 10.         scalar `A' = `at'[1, 1]
 11.         scalar `B' = `at'[1, 2]
 12.         scalar `C' = `at'[1, 3]
 13.         scalar `D' = `at'[1, 4]
 14. 
.         tempvar yh t1 t2 t3 t4 denom
 15.         
.         * Linear predictor among those missing ethnicity
.         gen `denom' = 1 + exp(`A' + `lp1') + exp(`B' + `lp2') + exp(`C' + `lp3') + exp(`D'
>  + `lp4')
 16.         gen `t1' = exp(`A' + `lp1')/`denom'
 17.         gen `t2' = exp(`B' + `lp2')/`denom'
 18.         gen `t3' = exp(`C' + `lp3')/`denom'
 19.         gen `t4' = exp(`D' + `lp4')/`denom'
 20. 
.         qui summ `t1' if `r'==0
 21.         local t1sum=r(sum)
 22.         qui summ `t2' if `r'==0
 23.         local t2sum=r(sum)
 24.         qui summ `t3' if `r'==0
 25.         local t3sum=r(sum)
 26.         qui summ `t4' if `r'==0
 27.         local t4sum=r(sum)
 28.         
.         * Set equal to marginal expression (using external data)
.         gen double      `yh' =  `t1sum'*$r0star/$Nmis + $Eth1obsstar*$r1star - $Eth1 + 1 i
> n 1
 29.         replace         `yh' =  `t2sum'*$r0star/$Nmis + $Eth2obsstar*$r1star - $Eth2 in
>  2
 30.         replace         `yh' =  `t3sum'*$r0star/$Nmis + $Eth3obsstar*$r1star - $Eth3 in
>  3
 31.         replace         `yh' =  `t4sum'*$r0star/$Nmis + $Eth4obsstar*$r1star - $Eth4 in
>  4
 32. 
.         * Return 4 equations evaluated at current versions of parameter 
.         replace `y' = `yh'
 33. 
. end

. 
. 
. 
. 
. 
. *******************************
. *  Wrapper for program above  *
. *******************************
. 
. 
. cap prog drop nlnle2_wrap

. program nlnle2_wrap, rclass
  1. 
.         * Check inputs are there and print summary
. 
.         di _n "INPUTS:" 
  2.         
.         di _n "Missingness of ethnicity:"
  3.         di _col(10) "Number missing ethnicity data:   " $Nmis 
  4.         di _col(10) "Probability of missing  (drawn): " $r0star
  5.         di _col(10) "Probability of observed (drawn): " $r1star
  6. 
. 
.         di _n "Drawn proportions (among complete cases):"
  7.         di _col(10)"Black (drawn): " $Eth1obsstar
  8.         di _col(10)"Asian (drawn): " $Eth2obsstar
  9.         di _col(10)"Mixed (drawn): " $Eth3obsstar
 10.         di _col(10)"Other (drawn): " $Eth4obsstar
 11. 
.         di _n "External data:"
 12.         di _col(10) "Black (external): " $Eth1
 13.         di _col(10) "Asian (external): " $Eth2
 14.         di _col(10) "Mixed (external): " $Eth3
 15.         di _col(10) "Other (external): " $Eth4
 16. 
.         * Check linear predictor variables exist
.         confirm numeric variable lp1
 17.         confirm numeric variable lp2
 18.         confirm numeric variable lp3
 19.         confirm numeric variable lp4
 20.            
. 
.         * Create variable to house estimation results
.         qui gen     y = 1 in 1
 21.         qui replace y = 0 in 2
 22.         qui replace y = 0 in 3
 23.         qui replace y = 0 in 4
 24. 
.         qui nl nle2 @ y lp1 lp2 lp3 lp4 r, ///
>                 parameters(A B C D) initial(A 2 B 2 C 2 D 2)
 25.         qui drop y 
 26. 
.         * Convert calibration parameters into RR for being observed among r=0 vs r=1
.         mat def G = e(b)
 27.         * On logged scale
.         local delta1 = G[1,1]
 28.         local delta2 = G[1,2]
 29.         local delta3 = G[1,3]
 30.         local delta3 = G[1,4]
 31.         * On RR scale
.         local gamma1 = exp(G[1,1])
 32.         local gamma2 = exp(G[1,2])
 33.         local gamma3 = exp(G[1,3])
 34.         local gamma4 = exp(G[1,4])
 35. 
.         
.         /*  Return parameters  */ 
.         
.         return scalar rr1 = `gamma1'
 36.         return scalar rr2 = `gamma2'
 37.         return scalar rr3 = `gamma3'
 38.         return scalar rr4 = `gamma4'
 39.         
.         noi di _n "ESTIMATED CALIBRATION PARAMETERS:  "
 40. 
.         noi di _col(10) "Parameter (log scale):"
 41.         noi di _col(10) "Black:  " `delta1'
 42.         noi di _col(10) "Asian:  " `delta2'
 43.         noi di _col(10) "Mixed:  " `delta3'
 44.         noi di _col(10) "Other:  " `delta4'
 45.         noi di _col(10) "Relative risk (for being this ethnicity (vs white)"
 46.         noi di _col(15) "...in missing cf complete cases):"
 47.         noi di _col(10) "Black:  " `gamma1'
 48.         noi di _col(10) "Asian:  " `gamma2'
 49.         noi di _col(10) "Mixed:  " `gamma3'
 50.         noi di _col(10) "Other:  " `gamma4'
 51.         
. end

. 
. 
. 
end of do-file

. do Calibration_parameter_estimation.do  

. ********************************************************************************
. *
. *       Do-file:                Calibration_parameter_estimation.do
. *
. *       Project:                Risk factors for poor outcomes in Covid-19; Ethnicity MNAR
. *
. *       Programmed by:  Fizz
. *
. *       Data used:              None
. *
. *       Data created:   None
. *
. *       Other output:   User-written programs:  count_missing and prop_ethnicity
. *
. ********************************************************************************
. *
. *       Purpose:                This do-file creates programs which count the proportion 
. *                                       of missing ethnicity data, and the proportion in e
> ach group
. *                                       in the complete case data. 
. *
. *                                       It then draws these parameters from their posterio
> r 
. *                                       predictive distributions. 
. *
. *       ASSUMPTIONS:    This is a complete case sample, other than ethnicity.
. *                                       Ethnicity is White, Black, Asian, Mixed, other
. *                                       (same order, coding (1, 2, 3, 4, 5), labelling)
. *  
. ********************************************************************************
. 
. 
. 
. 
. ***************************************************
. *  Observed and drawn proportions of missingness  *
. ***************************************************
. 
. 
. capture program drop count_missing

. program define count_missing, rclass
  1.         syntax varname
  2.         
.         
.         /*      Number of patients with missing ethnicity  */
. 
.         * Overall
.         qui count if `varlist' == 0 
  3.         local Nmis = r(N)
  4.         qui count if `varlist' == 1
  5.         local Nobs = r(N)
  6. 
.         
.         /*  Draw probability of observing ethnicity  */
. 
. 
.         * Sample proportion of observed ethnicity
.         qui count if `varlist' == 0
  7.         local r0 = r(N)/_N
  8.         local se_r0 = sqrt((`r0'*(1-`r0'))/_N)
  9. 
.         ** Draw probability from the normal approximation
.         ** whose mean is the sample proportion of observed ethnicities
.         local r0star = rnormal(`r0', `se_r0')
 10.         local r1star = 1-`r0star'
 11. 
. 
.         /*  Return probabilities  */
.         
.         * Observed proportions
.         return scalar Nmis = `Nmis'
 12.         return scalar Nobs = `Nobs'
 13.         
.         * Drawn probabilities 
.         return scalar r0star = `r0star'
 14.         return scalar r1star = `r1star'
 15. 
.         
.         /*  Display results  */
.         
.         noi di _n "Observed proportions:"
 16.         
.         noi di _col(10) "Number Missing:   " `Nmis'
 17.         noi di _col(10) "Number Observed:  " `Nobs'
 18.         
.         noi di _n "Drawn probabilities:"
 19.         
.         noi di _col(10)  "P(Missing):        " `r0star'
 20.         noi di _col(10)  "P(Observed):       " `r1star'
 21.         
. end

.         
.         
.         
.         
. ***************************************************************
. *  Observed and drawn proportions of each ethnicity category  *
. ***************************************************************
. 
. 
. capture program drop prop_ethnicity

. program define prop_ethnicity, rclass
  1.         syntax varname
  2.         
.         * Check there are 4 categories
.         assert inlist(`varlist', 1, 2, 3, 4, 5, ., .u)
  3.         
.         * Count number of observations
.         qui count if `varlist'<.
  4.         local nobs = r(N)
  5.         
.         /*  Draw probability of each ethnicity category  */ 
. 
.         * Pick up observed proportions of each ethnicity (in complete cases)
.         prop `varlist'  
  6.         mat def Eth_m = r(table)
  7. 
.         ** Draw probability from the normal approximation
.         ** whose mean is the corresponding observed proportion of each category
.         forvalues i = 2 (1) 5 {
  8.             local j = `i' - 1
  9.                 local Eth`j'obs = Eth_m[1,`i']
 10.                 local se_Eth`j'obs = sqrt((`Eth`j'obs'*(1-`Eth`j'obs'))/(`nobs'))
 11.                 local Eth`j'obsstar = rnormal(`Eth`j'obs', `se_Eth`j'obs')
 12.         }
 13.         matrix drop Eth_m
 14.         
. 
.         /*  Return probabilities  */
.         
.         * Observed proportions
.         return scalar Eth1obs = `Eth1obs'
 15.         return scalar Eth2obs = `Eth2obs'
 16.         return scalar Eth3obs = `Eth3obs'
 17.         return scalar Eth4obs = `Eth4obs'
 18.         
.         * Drawn probabilities 
.         return scalar Eth1obsstar = `Eth1obsstar'
 19.         return scalar Eth2obsstar = `Eth2obsstar'
 20.         return scalar Eth3obsstar = `Eth3obsstar'
 21.         return scalar Eth4obsstar = `Eth4obsstar'
 22. 
.         
.         /*  Display results  */
.         
.         noi di _n "Observed proportions of each ethnic group:"
 23.         
.         noi di _col(10) "Proportion Black:   " `Eth1obs'
 24.         noi di _col(10) "Proportion Asian:   " `Eth2obs'
 25.         noi di _col(10) "Proportion Mixed:   " `Eth3obs'
 26.         noi di _col(10) "Proportion Other:   " `Eth4obs'
 27.         
.         noi di _n "Drawn probabilities of each ethnic group:"
 28.         
.         noi di _col(10)  "P(Black | r=1):  " `Eth1obsstar'
 29.         noi di _col(10)  "P(Asian | r=1):  " `Eth2obsstar'
 30.         noi di _col(10)  "P(Mixed | r=1):  " `Eth3obsstar'
 31.         noi di _col(10)  "P(Other | r=1):  " `Eth4obsstar'
 32. 
. end

. 
. 
. 
. 
end of do-file

. 
. 
. 
. ********************************   NOTES  **************************************
. 
. *  Assumes region is string, taking  values: 
. *    East, East Midlands, London, North East, North West, South East, 
. *    South West, West Midlands, and Yorkshire and The Humber
. *
. *  Assumes ethnicity is numeric, taking values: 
. *       1, 2, 3, 4, 5, (missing: . or .u)
. *       in the order White, Black, Asian, Mixed, Other
. *       with value labels exactly as above. 
. *       (NB: this is now intially recoded from ordering: 
. *      White, Mixed, Asian, Black, Other)       
. *
. *
. *  Assumes a complete case sample other than ethnicity
. *
. ********************************************************************************
. 
.                         
.                         
. *******************************************************
. *  Perform imputations within each region separately  *
. *******************************************************
. 
. * List of regions
. global region1 = "East"

. global region2 = "East Midlands"        

. global region3 = "London" 

. global region4 = "North East" 

. global region5 = "North West" 

. global region6 = "South East" 

. global region7 = "South West" 

. global region8 = "West Midlands" 

. global region9 = "Yorkshire and The Humber"  

. 
. 
. 
. 
. * Loop over the regions  
. forvalues k = 1 (1) 1 {
  2.         
.         * Open data 
.         use cr_create_analysis_dataset.dta, clear
  3.         tab region, m
  4.         
. 
.         * Only keep data from one region
.         keep if region=="${region`k'}"
  5.         tab region, m   
  6.                 
.         * Change ordering of ethnicity
.         label define ethnicity 1 "White" 2 "Black" 3 "Asian" 4 "Mixed" 5 "Other", modify
  7.         recode ethnicity 1=1 2=4 3=3 4=2 5=5
  8. 
.         
.         * Only keep required variables
.         keep patient_id stp region ethnicity                            ///
>                 stime_cpnsdeath cpnsdeath enter_date                    ///
>                 agegroup male obese4cat                                                 //
> /
>                 smoke_nomiss imd htdiag_or_highbp                               ///
>                 chronic_respiratory_disease                                     ///
>                 asthmacat                                                                 
>               ///
>                 chronic_cardiac_disease                                                 //
> /
>                 diabcat                                                                   
>               ///
>                 cancer_exhaem_cat                                                         
>       ///
>                 cancer_haem_cat                                                           
>       ///
>                 chronic_liver_disease                                                   //
> /
>                 stroke_dementia                                                           
>       ///
>                 other_neuro                                                               
>               ///
>                 chronic_kidney_disease                                                  //
> /
>                 organ_transplant                                                          
>       ///
>                 spleen                                                                    
>               ///
>                 ra_sle_psoriasis                                                          
>       ///
>                 other_immunosuppression
  9. 
.                         
.         * Create complete case sample (except for ethnicity) 
.         drop if imd>=. 
 10. 
.         * Set as survival
.         stset stime_cpnsdeath, fail(cpnsdeath) enter(enter_date)        ///
>                 origin(enter_date) id(patient_id)
 11. 
.         * Generate the Nelson-Aalen estimate of the cumulative hazard
.         sts generate cumh = na 
 12.         egen cumhgp = cut(cumh), group(5) 
 13.         replace cumhgp = cumhgp+1
 14. 
.         * Gene missingness indicator
.         gen r = 1 - missing(ethnicity)
 15. 
.         * Create dummy variables for categorical predictors
.         foreach var of varlist agegroup obese4cat smoke_nomiss imd  ///
>                 asthmacat diabcat cancer_exhaem_cat cancer_haem_cat             ///
>                 stp cumhgp {
 16.                         egen ord_`var' = group(`var')
 17.                         qui summ ord_`var'
 18.                         local max=r(max)
 19.                         forvalues i = 1 (1) `max' {
 20.                                 gen `var'_`i' = (`var'==`i')
 21.                         }       
 22.                         drop ord_`var'
 23.                         drop `var'_1
 24.         }
 25.         
. 
. 
.         forvalues m = 1 (1) 5   {
 26.         
.                 /*      Number of patients with missing ethnicity  */
. 
.                 count_missing r
 27.                 global Nmis = r(Nmis)
 28.                 global Nobs = r(Nobs)
 29. 
. 
.                 /*  Draw probability of observing ethnicity  */
. 
.                 global r0star = r(r0star)
 30.                 global r1star = r(r1star)
 31. 
. 
.                 /*  Draw probability of each ethnicity category  */ 
. 
.                 prop_ethnicity ethnicity
 32.                 forvalues j = 1 (1) 4 {
 33.                         global Eth`j'obsstar = r(Eth`j'obsstar)
 34.                 }
 35. 
.                         
.                         
.                 *******************************************************************
.                 *  External parameters needed to estimate calibration parameters  *
.                 *******************************************************************
.                         
.                 /*      External data distribution of ethnicity         */
. 
.                 if `k'==1 {     // East
 36.                         global Eth1 = 0.02252
 37.                         global Eth2 = 0.048303
 38.                         global Eth3 = 0.016971
 39.                         global Eth4 = 0.009791  
 40.                 }
 41.                 else if `k'==2 {        // East Midlands
 42.                         global Eth1 = 0.019259
 43.                         global Eth2 = 0.062222
 44.                         global Eth3 = 0.012698
 45.                         global Eth4 = 0.008254
 46.                 }
 47.                 else if `k'==3 {        // London
 48.                         global Eth1 = 0.124872
 49.                         global Eth2 = 0.183715
 50.                         global Eth3 = 0.037176
 51.                         global Eth4 = 0.060554
 52.                 }               
 53.                 else if `k'==4 {        // North East
 54.                         global Eth1 = 0.006447  
 55.                         global Eth2 = 0.029579
 56.                         global Eth3 = 0.005309
 57.                         global Eth4 = 0.006826
 58.                 }       
 59.                 else if `k'==5 {        // North West
 60.                         global Eth1 = 0.018688  
 61.                         global Eth2 = 0.06423
 62.                         global Eth3 = 0.012458
 63.                         global Eth4 = 0.011766
 64.                 }       
 65.                 else if `k'==6 {        // South East
 66.                         global Eth1 = 0.01665
 67.                         global Eth2 = 0.053826
 68.                         global Eth3 = 0.01722
 69.                         global Eth4 = 0.012544
 70.                 }       
 71.                 else if `k'==7 {        // South West
 72.                         global Eth1 = 0.009425  
 73.                         global Eth2 = 0.021388
 74.                         global Eth3 = 0.010332
 75.                         global Eth4 = 0.008519
 76.                 }       
 77.                 else if `k'==8 {        // West Midlands
 78.                         global Eth1 = 0.033207  
 79.                         global Eth2 = 0.121129
 80.                         global Eth3 = 0.015657
 81.                         global Eth4 = 0.014109
 82.                 }       
 83.                 else if `k'==9 {        // Yorkshire and the Humber
 84.                         global Eth1 = 0.015112
 85.                         global Eth2 = 0.066532
 86.                         global Eth3 = 0.014191
 87.                         global Eth4 = 0.011426
 88.                 }       
 89.                                 
. 
. 
. 
. 
. 
.                 ***********************************************************************
.                 *  Obtain linear predictor needed to estimate calibration parameters  *
.                 ***********************************************************************
. 
. 
.                 /*   Fit imputation model for ethnicity   */
. 
.                         
.                 * Fit imputation model for ethnicity
.                 capture drop temp
 90.                 noi uvis mlogit ethnicity                               ///
>                         stp_*                                                           //
> /
>                         cumhgp_* cpnsdeath                                      ///
>                         agegroup_*                                              ///
>                         male                                                            //
> /
>                         obese4cat_*                                                     //
> /
>                         smoke_nomiss_*                                          ///
>                         imd_*                                                           //
> /
>                         htdiag_or_highbp                                        ///
>                         chronic_respiratory_disease             ///
>                         asthmacat_*                                             ///
>                         chronic_cardiac_disease                         ///
>                         diabcat_*                                                       //
> /
>                         cancer_exhaem_cat_*                             ///
>                         cancer_haem_cat_*                                       ///
>                         chronic_liver_disease                           ///
>                         stroke_dementia                                         ///
>                         other_neuro                                                     //
> /
>                         chronic_kidney_disease                          ///
>                         organ_transplant                                        ///
>                         spleen                                                          //
> /
>                         ra_sle_psoriasis                                        ///
>                         other_immunosuppression,                        ///
>                         gen(temp) baseoutcome(1)
 91.                 drop temp
 92.                 
.                 * Obtain linear predictor, for P(eth=j | r=1)
.                 local eth_text_1 = "Black"
 93.                 local eth_text_2 = "Asian"
 94.                 local eth_text_3 = "Mixed"
 95.                 local eth_text_4 = "Other"
 96. 
.                 forvalues j = 1 (1) 4 {
 97.                         qui gen lp`j' = [`eth_text_`j'']_b[_cons]
 98.                         foreach var of varlist                                  ///
>                                 stp_*                                                     
>       ///
>                                 cumhgp_* cpnsdeath                                      //
> /
>                                 agegroup_*                                              //
> /
>                                 male obese4cat_*                                        //
> /
>                                 smoke_nomiss_*                                          //
> /
>                                 imd_*                                                     
>       ///
>                                 htdiag_or_highbp                                        //
> /
>                                 chronic_respiratory_disease             ///
>                                 asthmacat_*                                             //
> /
>                                 chronic_cardiac_disease                         ///
>                                 diabcat_*                                                 
>       ///
>                                 cancer_exhaem_cat_*                             ///
>                                 cancer_haem_cat_*                                       //
> /
>                                 chronic_liver_disease                           ///
>                                 stroke_dementia                                         //
> /
>                                 other_neuro                                               
>       ///
>                                 chronic_kidney_disease                          ///
>                                 organ_transplant                                        //
> /
>                                 spleen                                                    
>       ///
>                                 ra_sle_psoriasis                                        //
> /
>                                 other_immunosuppression                         ///
>                                  {
 99.                                  capture  di [`eth_text_`j'']_b[`var'] 
100.                                  if _rc==0 {
101.                                         qui replace lp`j' = lp`j' + [`eth_text_`j'']_b[
> `var']*(`var'==1)
102.                                 }
103.                         }
104.                 }
105. 
.                         
.                 * Create variable to house estimation results
.                 noi summ lp?
106.                 nlnle2_wrap
107.                 global gamma1 = r(rr1) 
108.                 global gamma2 = r(rr2) 
109.                 global gamma3 = r(rr3) 
110.                 global gamma4 = r(rr4) 
111. 
. 
.                 noi di "Weight for Black: " $gamma1
112.                 noi di "Weight for Asian: " $gamma2
113.                 noi di "Weight for Mixed: " $gamma3
114.                 noi di "Weight for Other: " $gamma4
115.                 
.                 
.                 * Delete variables no longer needed
.                 drop lp1 lp2 lp3 lp4
116.                 
.                 
. 
.                 **********************
.                 *  Impute ethnicity  *
.                 **********************
. 
. 
.                 /*  Use calibration parameters to generate probability weights (P(obs))  *
> /
. 
.                 * Missing ethnicities, assign a small weight
.                 * Observed ethnicities, weight = the RR from above (for non-ref groups)
.                 cap drop caldelw
117.                 gen     caldelw = 0.0001 
118.                 replace caldelw = 1           if ethnicity == 1
119.                 replace caldelw = $gamma1 if ethnicity == 2
120.                 replace caldelw = $gamma2 if ethnicity == 3
121.                 replace caldelw = $gamma3 if ethnicity == 4
122.                 replace caldelw = $gamma4 if ethnicity == 5
123. 
.                 noi tab caldelw ethnicity, m
124.                 noi di "Manual replacements to avoid crashes:"
125.                 replace caldelw = 0.1 if caldelw==0 & ethnicity<. // To avoid crashes
126. 
. 
.                 /*  Fit imputation model in weighted population */
.                 
.                 uvis mlogit ethnicity                                   ///
>                         stp_*                                                           //
> /
>                         cumhgp_* cpnsdeath                                      ///
>                         agegroup_*                                              ///
>                         male                                                            //
> /
>                         obese4cat_*                                                     //
> /
>                         smoke_nomiss_*                                          ///
>                         imd_*                                                           //
> /
>                         htdiag_or_highbp                                        ///
>                         chronic_respiratory_disease             ///
>                         asthmacat_*                                             ///
>                         chronic_cardiac_disease                         ///
>                         diabcat_*                                                       //
> /
>                         cancer_exhaem_cat_*                             ///
>                         cancer_haem_cat_*                                       ///
>                         chronic_liver_disease                           ///
>                         stroke_dementia                                         ///
>                         other_neuro                                                     //
> /
>                         chronic_kidney_disease                          ///
>                         organ_transplant                                        ///
>                         spleen                                                          //
> /
>                         ra_sle_psoriasis                                        ///
>                         other_immunosuppression                         ///
>                         [pw=caldelw],                                           ///
>                         baseoutcome(1)                                          ///
>                         gen(ethnicity`m') 
127.                 drop caldelw
128.                 
.         }
129. 
.         * Keep the imputed data and patient ID for each region
.         keep patient_id region ethnicity*
130. 
.         * Save the data
.         save imputed_`k', replace
131. }
(Analysis dataset for the poor outcomes in Covid project)

     Geographical region |      Freq.     Percent        Cum.
-------------------------+-----------------------------------
                         |        691        0.00        0.00
                    East |  4,049,564       23.25       23.25
           East Midlands |  3,067,130       17.61       40.86
                  London |  1,197,806        6.88       47.73
              North East |    810,319        4.65       52.38
              North West |  1,558,493        8.95       61.33
              South East |  1,174,256        6.74       68.07
              South West |  2,363,994       13.57       81.64
           West Midlands |    696,191        4.00       85.64
Yorkshire and The Humber |  2,502,150       14.36      100.00
-------------------------+-----------------------------------
                   Total | 17,420,594      100.00
(13,371,030 observations deleted)

     Geographical region |      Freq.     Percent        Cum.
-------------------------+-----------------------------------
                    East |  4,049,564      100.00      100.00
-------------------------+-----------------------------------
                   Total |  4,049,564      100.00
(ethnicity: 121916 changes made)
(32,332 observations deleted)

                id:  patient_id
     failure event:  cpnsdeath != 0 & cpnsdeath < .
obs. time interval:  (stime_cpnsdeath[_n-1], stime_cpnsdeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
  4,017,232  total observations
        102  observations end on or before enter()
------------------------------------------------------------------------------
  4,017,130  observations remaining, representing
  4,017,130  subjects
      1,499  failures in single-failure-per-subject data
  337042721  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        84
(102 missing values generated)
(4,017,130 real changes made)
(102 missing values generated)

Observed proportions:
         Number Missing:   1095209
         Number Observed:  2922023

Drawn probabilities:
         P(Missing):        .27307781
         P(Observed):       .72692219

Proportion estimation             Number of obs   =  2,922,023

--------------------------------------------------------------
             |                                   Logit
             | Proportion   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
   ethnicity |
      White  |   .8834677   .0001877      .8830993    .8838351
      Black  |   .0275135   .0000957      .0273265    .0277016
      Asian  |   .0552795   .0001337      .0550181    .0555421
      Mixed  |   .0135981   .0000678       .013466    .0137315
      Other  |   .0201412   .0000822      .0199807    .0203029
--------------------------------------------------------------

Observed proportions of each ethnic group:
         Proportion Black:   .02751347
         Proportion Asian:   .05527951
         Proportion Mixed:   .01359811
         Proportion Other:   .02014118

Drawn probabilities of each ethnic group:
         P(Black | r=1):  .02761324
         P(Asian | r=1):  .05531931
         P(Mixed | r=1):  .01348143
         P(Other | r=1):  .02008126
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 = 0.699]

1095209 missing observations on ethnicity imputed from 2922023 complete observations.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         lp1 |  4,017,232   -3.971439    1.204328  -9.878064   1.197868
         lp2 |  4,017,232   -3.240797    1.187746  -8.620999   1.009114
         lp3 |  4,017,232   -4.424763    .9063855  -8.272863  -1.526853
         lp4 |  4,017,232   -4.110208    1.029824  -9.451752  -1.039643

INPUTS:

Missingness of ethnicity:
         Number missing ethnicity data:   1095209
         Probability of missing  (drawn): .27307781
         Probability of observed (drawn): .72692219

Drawn proportions (among complete cases):
         Black (drawn): .02761324
         Asian (drawn): .05531931
         Mixed (drawn): .01348143
         Other (drawn): .02008126

External data:
         Black (external): .02252
         Asian (external): .048303
         Mixed (external): .016971
         Other (external): .009791

ESTIMATED CALIBRATION PARAMETERS:  
         Parameter (log scale):
         Black:  -1.2264776
         Asian:  -.80571543
         Mixed:  -592.94061
         Other:  
         Relative risk (for being this ethnicity (vs white)
              ...in missing cf complete cases):
         Black:  .29332397
         Asian:  .44676818
         Mixed:  1.7198442
         Other:  3.08e-258
Weight for Black: .29332397
Weight for Asian: .44676818
Weight for Mixed: 1.7198442
Weight for Other: 3.08e-258
(2,581,513 real changes made)
(80,395 real changes made)
(161,528 real changes made)
(39,734 real changes made)
(58,853 real changes made)

           |                             Ethnicity
   caldelw |     White      Black      Asian      Mixed      Other    Unknown |     Total
-----------+------------------------------------------------------------------+----------
         0 |         0          0          0          0     58,853          0 |    58,853 
     .0001 |         0          0          0          0          0  1,095,209 | 1,095,209 
   .293324 |         0     80,395          0          0          0          0 |    80,395 
  .4467682 |         0          0    161,528          0          0          0 |   161,528 
         1 | 2,581,513          0          0          0          0          0 | 2,581,513 
  1.719844 |         0          0          0     39,734          0          0 |    39,734 
-----------+------------------------------------------------------------------+----------
     Total | 2,581,513     80,395    161,528     39,734     58,853  1,095,209 | 4,017,232 
Manual replacements to avoid crashes:
(58,853 real changes made)
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 =  1.6e+14]

1095209 missing observations on ethnicity imputed from 2922023 complete observations.

Observed proportions:
         Number Missing:   1095209
         Number Observed:  2922023

Drawn probabilities:
         P(Missing):        .27278493
         P(Observed):       .72721507

Proportion estimation             Number of obs   =  2,922,023

--------------------------------------------------------------
             |                                   Logit
             | Proportion   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
   ethnicity |
      White  |   .8834677   .0001877      .8830993    .8838351
      Black  |   .0275135   .0000957      .0273265    .0277016
      Asian  |   .0552795   .0001337      .0550181    .0555421
      Mixed  |   .0135981   .0000678       .013466    .0137315
      Other  |   .0201412   .0000822      .0199807    .0203029
--------------------------------------------------------------

Observed proportions of each ethnic group:
         Proportion Black:   .02751347
         Proportion Asian:   .05527951
         Proportion Mixed:   .01359811
         Proportion Other:   .02014118

Drawn probabilities of each ethnic group:
         P(Black | r=1):  .02735777
         P(Asian | r=1):  .05555986
         P(Mixed | r=1):  .0134886
         P(Other | r=1):  .02012138
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 = 0.701]

1095209 missing observations on ethnicity imputed from 2922023 complete observations.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         lp1 |  4,017,232   -3.971439    1.204328  -9.878064   1.197868
         lp2 |  4,017,232   -3.240797    1.187746  -8.620999   1.009114
         lp3 |  4,017,232   -4.424763    .9063855  -8.272863  -1.526853
         lp4 |  4,017,232   -4.110208    1.029824  -9.451752  -1.039643

INPUTS:

Missingness of ethnicity:
         Number missing ethnicity data:   1095209
         Probability of missing  (drawn): .27278493
         Probability of observed (drawn): .72721507

Drawn proportions (among complete cases):
         Black (drawn): .02735777
         Asian (drawn): .05555986
         Mixed (drawn): .0134886
         Other (drawn): .02012138

External data:
         Black (external): .02252
         Asian (external): .048303
         Mixed (external): .016971
         Other (external): .009791

ESTIMATED CALIBRATION PARAMETERS:  
         Parameter (log scale):
         Black:  -1.1551498
         Asian:  -.8287425
         Mixed:  -406259.16
         Other:  
         Relative risk (for being this ethnicity (vs white)
              ...in missing cf complete cases):
         Black:  .31501033
         Asian:  .43659796
         Mixed:  1.7193831
         Other:  0
Weight for Black: .31501033
Weight for Asian: .43659796
Weight for Mixed: 1.7193831
Weight for Other: 0
(2,581,513 real changes made)
(80,395 real changes made)
(161,528 real changes made)
(39,734 real changes made)
(58,853 real changes made)

           |                             Ethnicity
   caldelw |     White      Black      Asian      Mixed      Other    Unknown |     Total
-----------+------------------------------------------------------------------+----------
         0 |         0          0          0          0     58,853          0 |    58,853 
     .0001 |         0          0          0          0          0  1,095,209 | 1,095,209 
  .3150103 |         0     80,395          0          0          0          0 |    80,395 
   .436598 |         0          0    161,528          0          0          0 |   161,528 
         1 | 2,581,513          0          0          0          0          0 | 2,581,513 
  1.719383 |         0          0          0     39,734          0          0 |    39,734 
-----------+------------------------------------------------------------------+----------
     Total | 2,581,513     80,395    161,528     39,734     58,853  1,095,209 | 4,017,232 
Manual replacements to avoid crashes:
(58,853 real changes made)
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 =  9.3e+12]

1095209 missing observations on ethnicity imputed from 2922023 complete observations.

Observed proportions:
         Number Missing:   1095209
         Number Observed:  2922023

Drawn probabilities:
         P(Missing):        .27248018
         P(Observed):       .72751982

Proportion estimation             Number of obs   =  2,922,023

--------------------------------------------------------------
             |                                   Logit
             | Proportion   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
   ethnicity |
      White  |   .8834677   .0001877      .8830993    .8838351
      Black  |   .0275135   .0000957      .0273265    .0277016
      Asian  |   .0552795   .0001337      .0550181    .0555421
      Mixed  |   .0135981   .0000678       .013466    .0137315
      Other  |   .0201412   .0000822      .0199807    .0203029
--------------------------------------------------------------

Observed proportions of each ethnic group:
         Proportion Black:   .02751347
         Proportion Asian:   .05527951
         Proportion Mixed:   .01359811
         Proportion Other:   .02014118

Drawn probabilities of each ethnic group:
         P(Black | r=1):  .02749629
         P(Asian | r=1):  .05525559
         P(Mixed | r=1):  .01352702
         P(Other | r=1):  .02011798
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 = 0.882]

1095209 missing observations on ethnicity imputed from 2922023 complete observations.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         lp1 |  4,017,232   -3.971439    1.204328  -9.878064   1.197868
         lp2 |  4,017,232   -3.240797    1.187746  -8.620999   1.009114
         lp3 |  4,017,232   -4.424763    .9063855  -8.272863  -1.526853
         lp4 |  4,017,232   -4.110208    1.029824  -9.451752  -1.039643

INPUTS:

Missingness of ethnicity:
         Number missing ethnicity data:   1095209
         Probability of missing  (drawn): .27248018
         Probability of observed (drawn): .72751982

Drawn proportions (among complete cases):
         Black (drawn): .02749629
         Asian (drawn): .05525559
         Mixed (drawn): .01352702
         Other (drawn): .02011798

External data:
         Black (external): .02252
         Asian (external): .048303
         Mixed (external): .016971
         Other (external): .009791

ESTIMATED CALIBRATION PARAMETERS:  
         Parameter (log scale):
         Black:  -1.1959261
         Asian:  -.80121378
         Mixed:  -1596283.1
         Other:  
         Relative risk (for being this ethnicity (vs white)
              ...in missing cf complete cases):
         Black:  .30242374
         Asian:  .44878391
         Mixed:  1.7145769
         Other:  0
Weight for Black: .30242374
Weight for Asian: .44878391
Weight for Mixed: 1.7145769
Weight for Other: 0
(2,581,513 real changes made)
(80,395 real changes made)
(161,528 real changes made)
(39,734 real changes made)
(58,853 real changes made)

           |                             Ethnicity
   caldelw |     White      Black      Asian      Mixed      Other    Unknown |     Total
-----------+------------------------------------------------------------------+----------
         0 |         0          0          0          0     58,853          0 |    58,853 
     .0001 |         0          0          0          0          0  1,095,209 | 1,095,209 
  .3024237 |         0     80,395          0          0          0          0 |    80,395 
  .4487839 |         0          0    161,528          0          0          0 |   161,528 
         1 | 2,581,513          0          0          0          0          0 | 2,581,513 
  1.714577 |         0          0          0     39,734          0          0 |    39,734 
-----------+------------------------------------------------------------------+----------
     Total | 2,581,513     80,395    161,528     39,734     58,853  1,095,209 | 4,017,232 
Manual replacements to avoid crashes:
(58,853 real changes made)
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 =  1.6e+14]

1095209 missing observations on ethnicity imputed from 2922023 complete observations.

Observed proportions:
         Number Missing:   1095209
         Number Observed:  2922023

Drawn probabilities:
         P(Missing):        .27219658
         P(Observed):       .72780342

Proportion estimation             Number of obs   =  2,922,023

--------------------------------------------------------------
             |                                   Logit
             | Proportion   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
   ethnicity |
      White  |   .8834677   .0001877      .8830993    .8838351
      Black  |   .0275135   .0000957      .0273265    .0277016
      Asian  |   .0552795   .0001337      .0550181    .0555421
      Mixed  |   .0135981   .0000678       .013466    .0137315
      Other  |   .0201412   .0000822      .0199807    .0203029
--------------------------------------------------------------

Observed proportions of each ethnic group:
         Proportion Black:   .02751347
         Proportion Asian:   .05527951
         Proportion Mixed:   .01359811
         Proportion Other:   .02014118

Drawn probabilities of each ethnic group:
         P(Black | r=1):  .02773558
         P(Asian | r=1):  .05494483
         P(Mixed | r=1):  .01362114
         P(Other | r=1):  .02006611
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 = 4.230]

1095209 missing observations on ethnicity imputed from 2922023 complete observations.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         lp1 |  4,017,232   -3.971439    1.204328  -9.878064   1.197868
         lp2 |  4,017,232   -3.240797    1.187746  -8.620999   1.009114
         lp3 |  4,017,232   -4.424763    .9063855  -8.272863  -1.526853
         lp4 |  4,017,232   -4.110208    1.029824  -9.451752  -1.039643

INPUTS:

Missingness of ethnicity:
         Number missing ethnicity data:   1095209
         Probability of missing  (drawn): .27219658
         Probability of observed (drawn): .72780342

Drawn proportions (among complete cases):
         Black (drawn): .02773558
         Asian (drawn): .05494483
         Mixed (drawn): .01362114
         Other (drawn): .02006611

External data:
         Black (external): .02252
         Asian (external): .048303
         Mixed (external): .016971
         Other (external): .009791

ESTIMATED CALIBRATION PARAMETERS:  
         Parameter (log scale):
         Black:  -1.2702384
         Asian:  -.77444189
         Mixed:  -157228.2
         Other:  
         Relative risk (for being this ethnicity (vs white)
              ...in missing cf complete cases):
         Black:  .28076467
         Asian:  .46096098
         Mixed:  1.6988057
         Other:  0
Weight for Black: .28076467
Weight for Asian: .46096098
Weight for Mixed: 1.6988057
Weight for Other: 0
(2,581,513 real changes made)
(80,395 real changes made)
(161,528 real changes made)
(39,734 real changes made)
(58,853 real changes made)

           |                             Ethnicity
   caldelw |     White      Black      Asian      Mixed      Other    Unknown |     Total
-----------+------------------------------------------------------------------+----------
         0 |         0          0          0          0     58,853          0 |    58,853 
     .0001 |         0          0          0          0          0  1,095,209 | 1,095,209 
  .2807647 |         0     80,395          0          0          0          0 |    80,395 
   .460961 |         0          0    161,528          0          0          0 |   161,528 
         1 | 2,581,513          0          0          0          0          0 | 2,581,513 
  1.698806 |         0          0          0     39,734          0          0 |    39,734 
-----------+------------------------------------------------------------------+----------
     Total | 2,581,513     80,395    161,528     39,734     58,853  1,095,209 | 4,017,232 
Manual replacements to avoid crashes:
(58,853 real changes made)
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 =  4.5e+10]

1095209 missing observations on ethnicity imputed from 2922023 complete observations.

Observed proportions:
         Number Missing:   1095209
         Number Observed:  2922023

Drawn probabilities:
         P(Missing):        .27247459
         P(Observed):       .72752541

Proportion estimation             Number of obs   =  2,922,023

--------------------------------------------------------------
             |                                   Logit
             | Proportion   Std. Err.     [95% Conf. Interval]
-------------+------------------------------------------------
   ethnicity |
      White  |   .8834677   .0001877      .8830993    .8838351
      Black  |   .0275135   .0000957      .0273265    .0277016
      Asian  |   .0552795   .0001337      .0550181    .0555421
      Mixed  |   .0135981   .0000678       .013466    .0137315
      Other  |   .0201412   .0000822      .0199807    .0203029
--------------------------------------------------------------

Observed proportions of each ethnic group:
         Proportion Black:   .02751347
         Proportion Asian:   .05527951
         Proportion Mixed:   .01359811
         Proportion Other:   .02014118

Drawn probabilities of each ethnic group:
         P(Black | r=1):  .02757424
         P(Asian | r=1):  .05525293
         P(Mixed | r=1):  .01357334
         P(Other | r=1):  .02013811
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 = 1.021]

1095209 missing observations on ethnicity imputed from 2922023 complete observations.

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
         lp1 |  4,017,232   -3.971439    1.204328  -9.878064   1.197868
         lp2 |  4,017,232   -3.240797    1.187746  -8.620999   1.009114
         lp3 |  4,017,232   -4.424763    .9063855  -8.272863  -1.526853
         lp4 |  4,017,232   -4.110208    1.029824  -9.451752  -1.039643

INPUTS:

Missingness of ethnicity:
         Number missing ethnicity data:   1095209
         Probability of missing  (drawn): .27247459
         Probability of observed (drawn): .72752541

Drawn proportions (among complete cases):
         Black (drawn): .02757424
         Asian (drawn): .05525293
         Mixed (drawn): .01357334
         Other (drawn): .02013811

External data:
         Black (external): .02252
         Asian (external): .048303
         Mixed (external): .016971
         Other (external): .009791

ESTIMATED CALIBRATION PARAMETERS:  
         Parameter (log scale):
         Black:  -1.2194548
         Asian:  -.80162839
         Mixed:  -2958539.7
         Other:  
         Relative risk (for being this ethnicity (vs white)
              ...in missing cf complete cases):
         Black:  .29539118
         Asian:  .44859788
         Mixed:  1.7055752
         Other:  0
Weight for Black: .29539118
Weight for Asian: .44859788
Weight for Mixed: 1.7055752
Weight for Other: 0
(2,581,513 real changes made)
(80,395 real changes made)
(161,528 real changes made)
(39,734 real changes made)
(58,853 real changes made)

           |                             Ethnicity
   caldelw |     White      Black      Asian      Mixed      Other    Unknown |     Total
-----------+------------------------------------------------------------------+----------
         0 |         0          0          0          0     58,853          0 |    58,853 
     .0001 |         0          0          0          0          0  1,095,209 | 1,095,209 
  .2953912 |         0     80,395          0          0          0          0 |    80,395 
  .4485979 |         0          0    161,528          0          0          0 |   161,528 
         1 | 2,581,513          0          0          0          0          0 | 2,581,513 
  1.705575 |         0          0          0     39,734          0          0 |    39,734 
-----------+------------------------------------------------------------------+----------
     Total | 2,581,513     80,395    161,528     39,734     58,853  1,095,209 | 4,017,232 
Manual replacements to avoid crashes:
(58,853 real changes made)
[imputing by drawing from conditional distribution without bootstrap]
[true/approx likelihood = 0.000/0.000 =  4.9e+06]

1095209 missing observations on ethnicity imputed from 2922023 complete observations.
file imputed_1.dta saved

. 
. 
. log close
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/an_checkassumptions_3_1.log
  log type:  text
 closed on:  30 Apr 2020, 20:43:05
--------------------------------------------------------------------------------------------
