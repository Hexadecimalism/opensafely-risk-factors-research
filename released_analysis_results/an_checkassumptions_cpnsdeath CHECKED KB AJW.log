--------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/an_checkassumptions_cpnsdeath.log
  log type:  text
 opened on:  30 Apr 2020, 05:27:12

. 
. use cr_create_analysis_dataset, clear
(Analysis dataset for the poor outcomes in Covid project)

. 
. *local outcome "cpnsdeath"
. *replace cpnsdeath = uniform()<0.3
. 
. 
. 
. ******************************
. *  Multivariable Cox models  *
. ******************************
. 
. *************************************************************************************
. *PROG TO DEFINE THE BASIC COX MODEL WITH OPTIONS FOR HANDLING OF AGE, BMI, ETHNICITY:
. cap prog drop basecoxmodel

. prog define basecoxmodel
  1.         syntax , age(string) [ethnicity(real 0) if(string)] 
  2. 
.         if `ethnicity'==1 local ethnicity "i.ethnicity"
  3.         else local ethnicity
  4. timer clear
  5. timer on 1
  6.         capture stcox   `age'                                   ///
>                         i.male                                                  ///
>                         i.obese4cat                                             ///
>                         i.smoke_nomiss                                  ///
>                         `ethnicity'                                             ///
>                         i.imd                                                   ///
>                         i.htdiag_or_highbp                              ///
>                         i.chronic_respiratory_disease   ///
>                         i.asthmacat                                             ///
>                         i.chronic_cardiac_disease               ///
>                         i.diabcat                                               ///
>                         i.cancer_exhaem_cat                             ///
>                         i.cancer_haem_cat                               ///
>                         i.chronic_liver_disease                 ///
>                         i.stroke_dementia                               ///
>                         i.other_neuro                                   ///
>                         i.chronic_kidney_disease                ///
>                         i.organ_transplant                              ///
>                         i.spleen                                                ///
>                         i.ra_sle_psoriasis                      ///
>                         other_immunosuppression                 ///
>                         `if'                                                    ///
>                         , strata(stp)
  7. timer off 1
  8. timer list
  9. end

. *************************************************************************************
. 
. 
. 
. * Set as survival outcome
. stset stime_`outcome', fail(`outcome') enter(enter_date) origin(enter_date) id(patient_id)
>  

                id:  patient_id
     failure event:  cpnsdeath != 0 & cpnsdeath < .
obs. time interval:  (stime_cpnsdeath[_n-1], stime_cpnsdeath]
 enter on or after:  time enter_date
 exit on or before:  failure
    t for analysis:  (time-origin)
            origin:  time enter_date

------------------------------------------------------------------------------
   17420594  total observations
        466  observations end on or before enter()
------------------------------------------------------------------------------
   17420128  observations remaining, representing
   17420128  subjects
      5,707  failures in single-failure-per-subject data
 1.4615e+09  total analysis time at risk and under observation
                                                at risk from t =         0
                                     earliest observed entry t =         0
                                          last observed exit t =        84

. 
. 
.                         
. * Age spline model (not adj ethnicity)
. basecoxmodel, age("age1 age2 age3")  ethnicity(0)
   1:   2131.19 /        1 =    2131.1940

. if _rc==0 {
.         
.         estimates

--------------------------------------------------------------------------------------------
active results
--------------------------------------------------------------------------------------------

Stratified Cox regr. -- Breslow method for ties

No. of subjects =   17,284,549                  Number of obs    =  17,284,549
No. of failures =        5,674
Time at risk    =   1450148718
                                                LR chi2(35)      =    18496.23
Log likelihood  =    -67060.03                  Prob > chi2      =      0.0000

-------------------------------------------------------------------------------------------
                       _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
--------------------------+----------------------------------------------------------------
                     age1 |   1.133752   .0275635     5.16   0.000     1.080995    1.189083
                     age2 |   .9559775   .0517433    -0.83   0.406     .8597565    1.062967
                     age3 |   1.068498   .1354484     0.52   0.601     .8334333    1.369861
                   1.male |   1.974864   .0566948    23.70   0.000     1.866813     2.08917
                          |
                obese4cat |
       Obese I (30-34.9)  |   1.269188   .0438829     6.89   0.000     1.186029    1.358178
      Obese II (35-39.9)  |   1.563049   .0793089     8.80   0.000     1.415085    1.726483
         Obese III (40+)  |   2.264135   .1514857    12.21   0.000     1.985872    2.581388
                          |
             smoke_nomiss |
                  Former  |   1.258286   .0386241     7.48   0.000     1.184816    1.336311
                 Current  |   .8805916   .0508254    -2.20   0.028     .7864036    .9860606
                          |
                      imd |
                       2  |    1.14455   .0514699     3.00   0.003     1.047989    1.250008
                       3  |   1.222405   .0549105     4.47   0.000     1.119384    1.334908
                       4  |   1.494762   .0659907     9.10   0.000      1.37086    1.629862
         5 most deprived  |   1.740349   .0787277    12.25   0.000     1.592689      1.9017
                          |
       1.htdiag_or_highbp |   .9559873   .0309098    -1.39   0.164     .8972848     1.01853
1.chronic_respiratory_d~e |   1.778106   .0602833    16.98   0.000     1.663793    1.900273
                          |
                asthmacat |
             Yes, no OCS  |   1.106755   .0449781     2.50   0.013     1.022019    1.198517
            Yes with OCS  |   1.225445   .0904476     2.75   0.006     1.060397    1.416183
                          |
1.chronic_cardiac_disease |   1.263832   .0377536     7.84   0.000     1.191961    1.340036
                          |
                  diabcat |
     Controlled diabetes  |   1.510013   .0512497    12.14   0.000     1.412834    1.613877
   Uncontrolled diabetes  |   2.366587   .0989485    20.60   0.000     2.180385    2.568691
Diabetes, no hba1c mea..  |   1.862576   .1249894     9.27   0.000     1.633027    2.124391
                          |
        cancer_exhaem_cat |
               Last year  |   1.507895   .1477314     4.19   0.000     1.244449    1.827111
           2-5 years ago  |    1.18097   .0775219     2.53   0.011     1.038398    1.343117
                5+ years  |   .9638885   .0436145    -0.81   0.416     .8820867    1.053276
                          |
          cancer_haem_cat |
               Last year  |   3.420364   .6606129     6.37   0.000      2.34245    4.994297
           2-5 years ago  |   3.073307   .3489048     9.89   0.000     2.460204    3.839199
                5+ years  |   1.856286   .1870346     6.14   0.000     1.523631    2.261568
                          |
  1.chronic_liver_disease |   1.608996   .1564257     4.89   0.000     1.329847    1.946741
        1.stroke_dementia |   1.796198   .0654001    16.09   0.000     1.672483    1.929064
            1.other_neuro |   2.431553   .1434554    15.06   0.000     2.166033    2.729622
 1.chronic_kidney_disease |   1.696217   .0524607    17.08   0.000      1.59645    1.802218
       1.organ_transplant |   4.232753   .6216051     9.82   0.000     3.174087    5.644519
                 1.spleen |   1.393979   .2919409     1.59   0.113     .9246748     2.10147
       1.ra_sle_psoriasis |   1.221728   .0562562     4.35   0.000     1.116297    1.337117
  other_immunosuppression |   1.680242      .2823     3.09   0.002     1.208816    2.335519
-------------------------------------------------------------------------------------------
                                                             Stratified by stp
.         * estimates save ./output/models/an_multivariate_cox_models_`outcome'_MAINFULLYADJ
> MODEL_agespline_bmicat_noeth, replace
. 
.         /*  Proportional Hazards test  */
.         
.         * Based on Schoenfeld residuals
.         timer clear 
.         timer on 1
.         if e(N_fail)>0 estat phtest, d

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      age1        |      0.02234         2.72        1         0.0993
      age2        |     -0.02886         4.49        1         0.0341
      age3        |      0.03157         5.35        1         0.0207
      0b.male     |            .            .        1             .
      1.male      |     -0.02697         4.16        1         0.0415
      1b.obese4cat|            .            .        1             .
      2.obese4cat |     -0.02026         2.33        1         0.1266
      3.obese4cat |      0.00231         0.03        1         0.8617
      4.obese4cat |     -0.01743         1.72        1         0.1895
      1b.smoke_n~s|            .            .        1             .
      2.smoke_no~s|     -0.01326         0.99        1         0.3200
      3.smoke_no~s|      0.01376         1.10        1         0.2943
      1b.imd      |            .            .        1             .
      2.imd       |      0.03549         7.12        1         0.0076
      3.imd       |      0.02951         4.88        1         0.0271
      4.imd       |      0.04244        10.10        1         0.0015
      5.imd       |      0.03800         8.09        1         0.0045
      0b.htdiag_~p|            .            .        1             .
      1.htdiag_o~p|     -0.00399         0.10        1         0.7577
      0b.c~respi~e|            .            .        1             .
      1.c~respir~e|     -0.03798         8.62        1         0.0033
      1b.asthmacat|            .            .        1             .
      2.asthmacat |     -0.01347         1.03        1         0.3109
      3.asthmacat |     -0.01839         1.95        1         0.1622
      0b.c~cardi~e|            .            .        1             .
      1.c~cardia~e|     -0.03800         8.60        1         0.0034
      1b.diabcat  |            .            .        1             .
      2.diabcat   |     -0.00389         0.09        1         0.7672
      3.diabcat   |     -0.03661         7.80        1         0.0052
      4.diabcat   |      0.00946         0.51        1         0.4739
      1b.c~exhae~t|            .            .        1             .
      2.cancer_e~t|     -0.00922         0.48        1         0.4866
      3.cancer_e~t|     -0.02780         4.41        1         0.0358
      4.cancer_e~t|      0.01225         0.85        1         0.3554
      1b.cancer_h~|            .            .        1             .
      2.cancer_h~t|     -0.00271         0.04        1         0.8382
      3.cancer_h~t|     -0.01141         0.74        1         0.3883
      4.cancer_h~t|      0.01327         1.01        1         0.3158
      0b.c~liver~e|            .            .        1             .
      1.c~liver_~e|     -0.01800         1.93        1         0.1645
      0b.stroke_~a|            .            .        1             .
      1.stroke_d~a|      0.03661         8.12        1         0.0044
      0b.other_n~o|            .            .        1             .
      1.other_ne~o|      0.01265         0.94        1         0.3323
      0b.c~kidne~e|            .            .        1             .
      1.c~kidney~e|      0.00339         0.07        1         0.7876
      0b.organ_t~t|            .            .        1             .
      1.organ_tr~t|      0.02885         4.87        1         0.0274
      0b.spleen   |            .            .        1             .
      1.spleen    |     -0.01163         0.77        1         0.3794
      0b.ra_sle_~s|            .            .        1             .
      1.ra_sle_p~s|     -0.01636         1.52        1         0.2172
      other_immu~n|     -0.01284         0.93        1         0.3353
      ------------+---------------------------------------------------
      global test |                    113.57       35         0.0000
      ----------------------------------------------------------------
.         timer off 1
.         timer list
   1:   2530.81 /        1 =    2530.8090
.         
.         
.         /*  Concordance statistic  */
.         
.         timer clear 
.         timer on 2
.         set seed 12437
.         
.         qui count if `outcome'==0
.         local N0 = r(N)
.         local p0 = 5000/`N0'
.         qui count if `outcome'==1
.         local N1 = r(N)
.         local p1 = 5000/`N1'    
.         
.         noi di "Fraction of controls to be used" `p0'
Fraction of controls to be used.00028711
.         noi di "Fraction of cases to be used" `p1'
Fraction of cases to be used.87611705
.         local csum = 0
.         forvalues i = 1 (1) 10 {
  2.                 gen     rsample`i' = uniform()<`p0' if `outcome'==0
  3.                 replace rsample`i' = uniform()<`p1' if `outcome'==1
  4.                 estat concordance if rsample`i'==1
  5.                 local cstat`i' =  r(C)
  6.                 noi di "C-statistic in `i' th sample = " `cstat`i''
  7.                 local csum = `csum' + `cstat`i''
  8.                 drop rsample`i'
  9.         }
(5,707 missing values generated)
(5,707 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7842
                            Somers' D =   0.5684
C-statistic in 1 th sample = .78419304
(5,707 missing values generated)
(5,707 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7805
                            Somers' D =   0.5610
C-statistic in 2 th sample = .78049183
(5,707 missing values generated)
(5,707 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7796
                            Somers' D =   0.5591
C-statistic in 3 th sample = .77956813
(5,707 missing values generated)
(5,707 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7787
                            Somers' D =   0.5575
C-statistic in 4 th sample = .77874678
(5,707 missing values generated)
(5,707 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7792
                            Somers' D =   0.5583
C-statistic in 5 th sample = .77917165
(5,707 missing values generated)
(5,707 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7771
                            Somers' D =   0.5542
C-statistic in 6 th sample = .77708019
(5,707 missing values generated)
(5,707 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7794
                            Somers' D =   0.5588
C-statistic in 7 th sample = .77941073
(5,707 missing values generated)
(5,707 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7794
                            Somers' D =   0.5587
C-statistic in 8 th sample = .77936047
(5,707 missing values generated)
(5,707 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7742
                            Somers' D =   0.5484
C-statistic in 9 th sample = .77422063
(5,707 missing values generated)
(5,707 real changes made)

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

  Harrell's C concordance statistic
  (note: different samples used to fit model and to calculate C statistic)

                          Harrell's C =   0.7798
                            Somers' D =   0.5596
C-statistic in 10 th sample = .77979862
.         local csum = `csum'/10
.         noi di "Average C-statistic = " `csum'
Average C-statistic = .77920421
.         timer off 2
.         timer list      
   2:   1362.81 /        1 =    1362.8100
.         
.         
.         /*  Brier score  */
.         
.         /*timer clear 
>         timer on 3
> 
>         * Calculate at 60 days
>         
>         * Unadjusted
>         capture stbrier, bt(60) efron
>         if _rc==0 {
>             noi di "Brier score, unadjusted"
>                 estimates
>         }
> 
>         * Fully adjusted
>         capture stbrier age1 age2 age3          ///
>                 i.male                                                  ///
>                 i.obese4cat                                             ///
>                 i.smoke_nomiss                                  ///
>                 i.imd                                                   ///
>                 i.htdiag_or_highbp                              ///
>                 i.chronic_respiratory_disease   ///
>                 i.asthmacat                                             ///
>                 i.chronic_cardiac_disease               ///
>                 i.diabcat                                               ///
>                 i.cancer_exhaem_cat                             ///
>                 i.cancer_haem_cat                               ///
>                 i.chronic_liver_disease                 ///
>                 i.stroke_dementia                               ///
>                 i.other_neuro                                   ///
>                 i.chronic_kidney_disease                ///
>                 i.organ_transplant                              ///
>                 i.spleen                                                ///
>                 i.ra_sle_psoriasis                      ///
>                 other_immunosuppression                 ///
>                 , shared(stp) bt(60)                    ///
>                 ipcw(age1 age2 age3                             ///
>                 i.male                                                  ///
>                 i.obese4cat                                             ///
>                 i.smoke_nomiss                                  ///
>                 i.imd                                                   ///
>                 i.htdiag_or_highbp                              ///
>                 i.chronic_respiratory_disease   ///
>                 i.asthmacat                                             ///
>                 i.chronic_cardiac_disease               ///
>                 i.diabcat                                               ///
>                 i.cancer_exhaem_cat                             ///
>                 i.cancer_haem_cat                               ///
>                 i.chronic_liver_disease                 ///
>                 i.stroke_dementia                               ///
>                 i.other_neuro                                   ///
>                 i.chronic_kidney_disease                ///
>                 i.organ_transplant                              ///
>                 i.spleen                                                ///
>                 i.ra_sle_psoriasis                      ///
>                 other_immunosuppression)
>         if _rc==0 {
>             noi di "Brier score, fully adjusted"
>                 estimates
>         }
> 
>         timer off 3
>         timer list
>         */
.         
. }

. else di "WARNING AGE SPLINE MODEL DID NOT FIT (OUTCOME `outcome')"

. 
. 
. 
. 
. 
. log close
      name:  <unnamed>
       log:  E:\analyses\alex-tmp-repo-2\analysis\output/an_checkassumptions_cpnsdeath.log
  log type:  text
 closed on:  30 Apr 2020, 07:12:57
--------------------------------------------------------------------------------------------
